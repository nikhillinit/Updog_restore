# P4.5: DnD Pipeline Interactions - Implementation Plan

**Status:** READY FOR REVIEW **Estimated effort:** ~4-5h across 6 tasks
**Branch:** `feat/pipeline-dnd` **Dependencies:** @dnd-kit/core,
@dnd-kit/utilities

## Architecture Summary

Add drag-and-drop to the pipeline kanban view, allowing deals to be moved
between status columns by dragging cards. No within-column reordering (server
determines order via priority DESC, updatedAt DESC). Feature-flagged behind
`enable_pipeline_dnd`.

**Library choice:** `@dnd-kit/core` only (no @dnd-kit/sortable needed — we only
move between columns, not reorder within them).

**Optimistic update strategy:** Hybrid — `onMutate` snapshots query data and
moves the card client-side instantly; `onError` rolls back; `onSettled` always
calls `invalidateQueries` so server state wins.

---

## Task Breakdown

### Task 4.5.0: Install @dnd-kit and register feature flag (~15 min)

**Files:**

- `package.json` — add `@dnd-kit/core`, `@dnd-kit/utilities`
- `shared/feature-flags/flag-definitions.ts` — add `enable_pipeline_dnd` flag
- `client/src/core/flags/flagAdapter.ts` — wire new flag into adapter

**Details:**

- `npm install @dnd-kit/core @dnd-kit/utilities`
- New flag definition:
  ```
  enable_pipeline_dnd: {
    key: 'enable_pipeline_dnd',
    name: 'Pipeline Drag and Drop',
    description: 'Drag deal cards between status columns in kanban view',
    enabled: false,
    rolloutPercentage: 0,
    dependencies: [],
  }
  ```
- Add to flagAdapter `getInitialFlagStates()` with ENV var fallback

**Acceptance:** Flag compiles, `npm run check` passes,
`useFeatureFlag('enable_pipeline_dnd')` returns false by default.

---

### Task 4.5.1: Create useDealDragDrop hook (~45 min)

**Files:**

- `client/src/hooks/useDealDragDrop.ts` (NEW)

**Details:**

- Custom hook encapsulating all DnD logic, keeping pipeline.tsx clean
- Exports:
  - `sensors` — PointerSensor with `activationConstraint: { distance: 5 }`
    (prevents click/drag conflict)
  - `handleDragStart(event)` — sets `activeDeal` state (the card being dragged)
  - `handleDragOver(event)` — tracks which column is being hovered (optional
    visual highlight)
  - `handleDragEnd(event)` — extracts dealId + new status, fires mutation if
    status changed
  - `activeDeal` — currently dragged deal (for DragOverlay rendering)
  - `stageMoveMutation` — TanStack mutation wrapping `POST /api/deals/:id/stage`
- Optimistic update pattern:
  ```
  onMutate: snapshot queryData, move deal in cache
  onError: restore snapshot
  onSettled: invalidateQueries(['/api/deals/opportunities'])
  ```
- Guard no-op drops: if `!over` or `over.id === deal.status`, return early
- Validate target status is in PIPELINE_STATUSES before mutating

**Acceptance:** Hook compiles, unit tests for no-op guard + optimistic rollback.

---

### Task 4.5.2: Wrap KanbanView with DnD context (~1h)

**Files:**

- `client/src/pages/pipeline.tsx` — modify KanbanView component

**Details:**

- Import `DndContext`, `DragOverlay`, `useDroppable` from `@dnd-kit/core`
- Wrap KanbanView return in `<DndContext>` with sensors + handlers from hook
- Each status column div gets a `useDroppable({ id: statusKey })` — add ref +
  setNodeRef
- Column visual feedback: when `isOver`, add subtle highlight (e.g.,
  `ring-2 ring-blue-200`)
- `<DragOverlay>` renders a ghost `<DealCard>` for the `activeDeal`
  (portal-based, avoids scroll clipping)
- Feature flag gate: if `!dndEnabled`, render current KanbanView unchanged (zero
  runtime cost)
- Preserve existing click behavior on DealCard — the 5px activation distance
  handles this

**Component structure (pseudocode):**

```
<DndContext sensors={sensors} onDragStart={...} onDragEnd={...}>
  <div className="flex gap-4 overflow-x-auto ...">
    {PIPELINE_STATUSES.map(status => (
      <DroppableColumn key={status.key} id={status.key} ...>
        {deals.map(deal => (
          <DraggableDealCard key={deal.id} deal={deal} />
        ))}
      </DroppableColumn>
    ))}
  </div>
  <DragOverlay>
    {activeDeal && <DealCard deal={activeDeal} />}
  </DragOverlay>
</DndContext>
```

**Acceptance:** Cards can be dragged between columns, status updates via API,
optimistic UI works, click-to-open still works.

---

### Task 4.5.3: DraggableDealCard + DroppableColumn components (~45 min)

**Files:**

- `client/src/components/pipeline/DraggableDealCard.tsx` (NEW)
- `client/src/components/pipeline/DroppableColumn.tsx` (NEW)

**Details:**

**DraggableDealCard:**

- Wraps `<DealCard>` with
  `useDraggable({ id: String(deal.id), data: { deal } })`
- Applies `transform` style from dnd-kit for smooth drag movement
- When dragging, reduces opacity (e.g., `opacity-50`) to show the card is being
  moved
- `aria-roledescription="draggable deal card"` for accessibility
- Keyboard: dnd-kit provides built-in keyboard sensor support

**DroppableColumn:**

- Wraps existing column div with `useDroppable({ id: statusKey })`
- `isOver` state controls visual highlight:
  `ring-2 ring-pov-blue/30 bg-blue-50/30`
- Empty column drop zone has larger hit area when `isOver`
- Column header badge animates (subtle pulse) when card hovers over it

**Acceptance:** Smooth drag visuals, column highlights on hover, ghost overlay
follows cursor, original card dims.

---

### Task 4.5.4: Clean up phantom react-beautiful-dnd (~20 min)

**Files:**

- `client/src/components/portfolio-constructor/FundStrategyBuilder.tsx` — remove
  react-beautiful-dnd imports, replace with @dnd-kit/core
- `client/src/types/react-beautiful-dnd.d.ts` — DELETE this type shim file

**Details:**

- FundStrategyBuilder uses DragDropContext/Droppable/Draggable for bucket
  reordering
- Migrate to @dnd-kit/core equivalents (DndContext + useSortable or just
  useDraggable)
- Since this is within-list reordering (not cross-column), may need
  @dnd-kit/sortable here — evaluate if the existing buckets reorder is even
  used/rendered
- If FundStrategyBuilder is dead code or not actively used, consider just
  removing the DnD entirely and using a simpler up/down button pattern
- Delete the `react-beautiful-dnd.d.ts` type declaration file

**Acceptance:** No references to react-beautiful-dnd anywhere in codebase,
`npm run check` passes.

---

### Task 4.5.5: Tests (~1.5h)

**Files:**

- `client/src/hooks/__tests__/useDealDragDrop.test.ts` (NEW)
- `client/src/components/pipeline/__tests__/DraggableDealCard.test.tsx` (NEW)
- `client/src/components/pipeline/__tests__/DroppableColumn.test.tsx` (NEW)
- `tests/e2e/pipeline-management.spec.ts` — add DnD E2E scenarios (if Playwright
  supports it)

**Unit tests (Vitest + RTL, jsdom):**

1. useDealDragDrop hook:
   - No-op when dropping on same column
   - No-op when dropping outside any column
   - Calls mutation with correct dealId + status on valid drop
   - Optimistic update moves deal in cache
   - Rollback restores deal on mutation error
   - Feature flag disabled: hook returns no-op handlers

2. DraggableDealCard:
   - Renders DealCard content
   - Has correct aria attributes
   - Applies opacity when dragging

3. DroppableColumn:
   - Renders children
   - Applies highlight class when isOver
   - Shows count badge

**E2E considerations:**

- Playwright DnD is possible via `page.dragAndDrop()` but fragile
- Consider adding a manual test checklist instead of automated E2E for DnD
- Or use data-testid attributes and Playwright's drag helpers

**Acceptance:** All unit tests pass, coverage for hook logic, no regressions in
existing 2,868 tests.

---

## Files Changed Summary

| File                                                                  | Action | Description                           |
| --------------------------------------------------------------------- | ------ | ------------------------------------- |
| `package.json`                                                        | MODIFY | Add @dnd-kit/core, @dnd-kit/utilities |
| `shared/feature-flags/flag-definitions.ts`                            | MODIFY | Add enable_pipeline_dnd flag          |
| `client/src/core/flags/flagAdapter.ts`                                | MODIFY | Wire new flag                         |
| `client/src/hooks/useDealDragDrop.ts`                                 | NEW    | DnD hook with optimistic updates      |
| `client/src/components/pipeline/DraggableDealCard.tsx`                | NEW    | Draggable card wrapper                |
| `client/src/components/pipeline/DroppableColumn.tsx`                  | NEW    | Droppable column wrapper              |
| `client/src/pages/pipeline.tsx`                                       | MODIFY | Integrate DnD into KanbanView         |
| `client/src/components/portfolio-constructor/FundStrategyBuilder.tsx` | MODIFY | Migrate from react-beautiful-dnd      |
| `client/src/types/react-beautiful-dnd.d.ts`                           | DELETE | Remove phantom type shim              |
| `client/src/hooks/__tests__/useDealDragDrop.test.ts`                  | NEW    | Hook unit tests                       |
| `client/src/components/pipeline/__tests__/DraggableDealCard.test.tsx` | NEW    | Component tests                       |
| `client/src/components/pipeline/__tests__/DroppableColumn.test.tsx`   | NEW    | Component tests                       |

## Risks & Mitigations

1. **Click vs drag conflict** — Mitigated by PointerSensor distance: 5px
   activation constraint
2. **Horizontal scroll clipping** — Mitigated by DragOverlay (renders in portal)
3. **FundStrategyBuilder migration scope creep** — If complex, defer to separate
   task and just delete the phantom imports
4. **Accessibility** — @dnd-kit has built-in keyboard sensor; add aria labels
   and announcements
5. **Race conditions on rapid drags** — Hybrid optimistic pattern handles via
   snapshot/rollback/invalidate

## Non-Goals (explicitly excluded)

- Within-column reordering (no position field in DB, server sorts)
- @dnd-kit/sortable (not needed for cross-column-only moves)
- Multi-card drag (use existing bulk actions for that)
- Touch/mobile drag (PointerSensor works on touch but not optimized)
- Custom drag preview animations (use default DragOverlay with DealCard)

## Execution Order

4.5.0 (install + flag) -> 4.5.1 (hook) -> 4.5.3 (components) -> 4.5.2
(integration) -> 4.5.4 (cleanup) -> 4.5.5 (tests)

Note: 4.5.1 and 4.5.3 can be developed in parallel since they're independent
modules.
