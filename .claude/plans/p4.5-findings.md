# P4.5 DnD Pipeline Findings

## Pipeline Architecture

- **Main page**: `client/src/pages/pipeline.tsx` (~800 lines)
- **KanbanView**: Lines 182-232 — groups deals by status into 8 fixed columns
- **ListView**: Lines 234-317 — flat list with optional bulk selection
- **DealCard**: `client/src/components/pipeline/DealCard.tsx` (141 lines)
- **Toolbar**: Inline in pipeline.tsx (search, filters, sort, view toggle)
- **Bulk actions**: Feature-flagged via `enable_pipeline_bulk_actions`

## Data Model

- **Table**: `deal_opportunities` in `shared/schema.ts:272-296`
- **Status field**: text, default 'lead'. Values: lead, qualified, pitch, dd,
  committee, term_sheet, closed, passed
- **NO position/sortOrder field** — within-column ordering not persisted
- **Activity log**: `pipeline_activities` table records all stage changes (type:
  'stage_change')

## API Endpoints (for DnD)

- **Single status move**: `POST /api/deals/:id/stage` — body:
  `{ status, notes? }`, returns updated deal + previousStatus
- **Bulk status**: `POST /api/deals/opportunities/bulk/status` — body:
  `{ dealIds[], status, notes? }`
- **Pipeline view**: `GET /api/deals/pipeline` — returns deals grouped by status

## Existing DnD State

- **react-beautiful-dnd**: Imported in FundStrategyBuilder.tsx but NOT INSTALLED
  in node_modules (phantom dependency, dead code)
- **@dnd-kit**: Not installed
- **No DnD packages in package.json at all**
- **Available motion libs**: framer-motion 12.27.1, @react-spring/web 10.0.1,
  @use-gesture/react 10.3.1

## Feature Flags

- `enable_pipeline_bulk_actions` (Phase 3, no dependencies, currently disabled)
- Flag system at `shared/feature-flags/flag-definitions.ts`
- Adapter at `client/src/core/flags/flagAdapter.ts`
- New flag needed: `enable_pipeline_dnd` (Phase 3)

## Key Architecture Decisions

1. **No position field**: Deals in columns sorted by server query (priority
   desc, updatedAt desc) — DnD only changes status (column), not within-column
   order
2. **Stage endpoint is perfect**: `POST /:id/stage` accepts `{ status }`, logs
   activity, returns updated deal
3. **Optimistic update pattern**: TanStack Query `setQueryData` for instant
   column move, roll back on error
4. **Board-only feature**: DnD makes sense only in kanban view, not list view

## DnD Integration Points

- Wrap each kanban column div in a droppable zone (column ID = status key)
- Wrap each DealCard in a draggable wrapper
- onDragEnd: call `POST /:id/stage` with new status
- Optimistic: move deal between columns immediately, refetch on success,
  rollback on failure
- Feature flag: gate entire DnD behind `enable_pipeline_dnd`
