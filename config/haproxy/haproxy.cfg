global
    maxconn 1000
    log stdout local0
    log stdout local1 notice
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s
    daemon

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    timeout connect 10s
    timeout client 30m
    timeout server 30m
    retries 3

# Statistics page
stats enable
stats uri /stats
stats refresh 30s
stats show-node

# Health check backend for Patroni/PostgreSQL
backend postgres_health
    option httpchk GET /primary
    http-check expect status 200

# Write connections - primary only
frontend postgres_write
    bind *:5432
    mode tcp
    default_backend postgres_primary_backend

backend postgres_primary_backend
    mode tcp
    option tcp-check
    tcp-check connect
    tcp-check send-binary 00000008 # PostgreSQL SSL request
    tcp-check expect binary 4E # 'N' - No SSL
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server primary postgres-primary:5432 check maxconn 100

# Read connections - primary + replicas with load balancing
frontend postgres_read
    bind *:5433
    mode tcp
    default_backend postgres_replicas_backend

backend postgres_replicas_backend
    mode tcp
    balance leastconn
    option tcp-check
    tcp-check connect
    tcp-check send-binary 00000008 # PostgreSQL SSL request
    tcp-check expect binary 4E # 'N' - No SSL
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server primary postgres-primary:5432 check maxconn 80 weight 100
    server replica1 postgres-replica:5432 check maxconn 80 weight 200 backup

# Admin interface
listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 30s
    stats show-node
    stats show-legends
    stats show-desc PostgreSQL RLS Load Balancer
    stats auth admin:${HAPROXY_STATS_PASSWORD}