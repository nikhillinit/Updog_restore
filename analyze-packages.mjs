#!/usr/bin/env node
import fs from 'fs';

// Read stats.json generated by rollup-plugin-visualizer
const statsPath = './dist/stats.json';

if (!fs.existsSync(statsPath)) {
  console.error('Error: dist/stats.json not found. Run npm run build first.');
  process.exit(1);
}

const stats = JSON.parse(fs.readFileSync(statsPath, 'utf8'));

// Aggregate sizes by npm package
const packageSizes = new Map();

function extractPackageName(filePath) {
  // Match node_modules package names
  if (filePath.includes('node_modules/')) {
    const match = filePath.match(/node_modules\/(@?[^/]+(?:\/[^/]+)?)/);
    if (match) return match[1];
  }

  // Match local project files
  if (filePath.includes('/client/')) return '[client-code]';
  if (filePath.includes('/shared/')) return '[shared-code]';
  if (filePath.includes('/server/')) return '[server-code]';
  if (filePath.includes('vite')) return '[vite]';

  return '[other]';
}

// Process all node parts
for (const [uid, part] of Object.entries(stats.nodeParts)) {
  // Find the corresponding meta
  const meta = Object.values(stats.nodeMetas).find(m =>
    Object.values(m.moduleParts || {}).includes(uid)
  );

  if (!meta) continue;

  const pkg = extractPackageName(meta.id || '');
  const current = packageSizes.get(pkg) || 0;
  packageSizes.set(pkg, current + part.gzipLength);
}

// Sort and display results
const sorted = Array.from(packageSizes.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 25);

console.log('\n[PACKAGES] Top 25 Contributors (Gzipped)\n');
console.log('Package                          Size        %');
console.log('─'.repeat(55));

const total = Array.from(packageSizes.values()).reduce((a, b) => a + b, 0);

for (const [pkg, size] of sorted) {
  const sizeKB = (size / 1024).toFixed(1);
  const pct = ((size / total) * 100).toFixed(1);
  const name = pkg.length > 32 ? pkg.slice(0, 29) + '...' : pkg;
  console.log(`${name.padEnd(32)} ${sizeKB.padStart(8)} KB ${pct.padStart(6)}%`);
}

console.log('─'.repeat(55));
console.log(`${'TOTAL'.padEnd(32)} ${(total / 1024).toFixed(1).padStart(8)} KB`);

// Check against target
const TARGET_KB = 600;
const isUnderTarget = total <= TARGET_KB * 1024;

console.log('\n' + (isUnderTarget ? '[PASS]' : '[FAIL]') + ` Target: <${TARGET_KB} KB gz\n`);
