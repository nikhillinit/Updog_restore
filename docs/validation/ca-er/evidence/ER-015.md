# Evidence Bundle: ER-015 - Period Boundary Inclusive Test

**Scenario ID:** ER-015 **Category:** term_validation **Status:** VALIDATION
REQUIRED **Generated:** 2025-12-13

---

## 1. Scenario Overview

**Description:** Exit on period boundary - exit in year 5 of 5-year recycling
period (inclusive boundary test)

**Focus:** Testing critical boundary condition where exit occurs in the final
year of the recycling period (year 5 of 5-year period), validating inclusive
boundary logic (year <= period, not year < period).

**Key Constraints:**

- Recycling period: 5 years (inclusive upper bound)
- Exit occurs in year 5 (boundary year)
- Must validate inclusive logic: year 5 IS eligible
- Recycling rate: 75% (partial recycling)
- Single exit scenario (no multi-period complexity)

---

## 2. Input Data (Verbatim from JSON)

```json
{
  "fundSize": 100,
  "recyclingCapPercent": 15,
  "recyclingPeriod": 5,
  "exitRecyclingRate": 75,
  "exits": [
    {
      "id": "Exit-A",
      "year": 5,
      "grossProceeds": 40,
      "ownershipPercent": 25
    }
  ]
}
```

**Interpretation:**

- Fund size: $100M
- Recycling cap: 15% of fund = $15M
- Recycling period: 5 years (inclusive)
- Exit recycling rate: 75%
- Single exit in year 5 (boundary year):
  - Gross proceeds: $40M
  - Fund ownership: 25%
  - Fund proceeds: $40M × 25% = $10M

---

## 3. Expected Output (Verbatim from JSON)

```json
{
  "totalRecycled": 7.5,
  "exitsWithinPeriod": 1,
  "exitsAfterPeriod": 0,
  "recycledFromEligibleExits": 7.5,
  "returnedFromIneligibleExits": 0,
  "recyclingByExit": [
    {
      "exitId": "Exit-A",
      "exitYear": 5,
      "fundProceeds": 10,
      "recycledAmount": 7.5,
      "returnedToLPs": 2.5,
      "withinPeriod": true,
      "appliedRate": 75
    }
  ]
}
```

**Key Expectations:**

- Total recycled: $7.5M (75% of $10M proceeds)
- Exits within period: 1 (year 5 IS within 5-year period)
- Exits after period: 0 (boundary is inclusive)
- Recycled from eligible exits: $7.5M
- Returned from ineligible exits: $0M (no ineligible exits)
- **Critical:** `withinPeriod: true` for year 5 of 5-year period

---

## 4. ADR Provenance

### ADR-008 Section 2.5: Recycling Integration

**Relevant Policy:**

> "Eligible distributions increase allocable capacity after reserve checks: When
> an exit generates proceeds that are eligible for recycling, these funds are
> added to the allocable capacity, but only after the reserve engine has
> verified that reserve requirements are met."

**Critical Interpretation for ER-015:**

The period boundary test validates a critical boundary condition:

1. **Inclusive Boundary Logic:**
   - Recycling period = 5 years means exits in years 1, 2, 3, 4, **AND 5** are
     eligible
   - Boundary condition: `year <= recyclingPeriod` (NOT
     `year < recyclingPeriod`)
   - Year 5 is the **last eligible year**, year 6 would be ineligible

2. **Off-by-One Protection:**
   - Incorrect logic (`year < period`) would make year 5 ineligible
   - This would cause unexpected behavior where "5-year period" actually means 4
     years
   - ER-015 validates correct inclusive implementation

3. **Policy Precedence:**
   - Period eligibility is checked **before** recycling rate application
   - `withinPeriod: true` enables recycling, then rate is applied
   - Order: Period check → Rate application → Capacity enforcement

**ADR Implicit Behavior:** ADR-008 Section 2.5 does not explicitly state
inclusive vs. exclusive boundary semantics. However, industry standard and
common sense interpretation require **inclusive boundaries**: a "5-year
recycling period" should include all of year 5. ER-015 validates this implicit
expectation.

**Boundary Precedent:**

- **ER-013:** Exit in year 3 of 5-year period (clearly within)
- **ER-014:** Exit in year 7 of 5-year period (clearly after)
- **ER-015:** Exit in year 5 of 5-year period (boundary test)
- **ER-016:** Mixed timing with year 5 boundary exit (complex validation)

---

## 5. Arithmetic Verification

### Step-by-Step Calculation

**Given:**

- Fund size: $100,000,000
- Recycling cap: 15%
- Recycling period: 5 years
- Exit recycling rate: 75%
- Exit A gross proceeds: $40,000,000
- Exit A ownership: 25%

**Step 1: Fund Proceeds**

```
Fund proceeds = Gross proceeds × Ownership %
              = $40,000,000 × 0.25
              = $10,000,000 ✓
```

**Step 2: Period Eligibility Check (CRITICAL)**

```
Exit year = 5
Recycling period = 5 years
Within period? = (exitYear <= recyclingPeriod)
               = (5 <= 5)
               = TRUE ✓ (Inclusive boundary)

Note: If logic were (exitYear < recyclingPeriod):
      = (5 < 5) = FALSE ❌ (Incorrect - would fail boundary test)
```

**Step 3: Recycled Amount**

```
Recycled amount = Fund proceeds × Recycling rate
                = $10,000,000 × 0.75
                = $7,500,000 ✓
```

**Step 4: Returned to LPs**

```
Returned to LPs = Fund proceeds - Recycled amount
                = $10,000,000 - $7,500,000
                = $2,500,000 ✓
```

**Step 5: Capacity Check**

```
Max recyclable capital = Fund size × Recycling cap %
                       = $100,000,000 × 0.15
                       = $15,000,000

Cumulative recycled = $7,500,000
Cap reached? = false ($7,500,000 < $15,000,000) ✓
Remaining capacity = $15,000,000 - $7,500,000 = $7,500,000 ✓
```

**Step 6: Exit Categorization**

```
Exits within period = 1 (Exit-A in year 5)
Exits after period = 0
Recycled from eligible = $7,500,000
Returned from ineligible = $0
```

### Node Verification

```bash
node -e 'const fundSize=100000000; const grossProceeds=40000000; const ownership=0.25; const rate=0.75; const fundProceeds=grossProceeds*ownership; const recycled=fundProceeds*rate; const returned=fundProceeds-recycled; console.log(JSON.stringify({fundProceeds_millions: fundProceeds/1000000, recycled_millions: recycled/1000000, returned_millions: returned/1000000, rate: rate*100+"%", verification: "Boundary condition - year 5 in 5-year period"}, null, 2))'
```

**Output:**

```json
{
  "fundProceeds_millions": 10,
  "recycled_millions": 7.5,
  "returned_millions": 2.5,
  "rate": "75%",
  "verification": "Boundary condition - year 5 in 5-year period"
}
```

**Verification Status:** ✓ PASS - All calculations match expected output exactly

---

## 6. Tolerance Check

**Specified Tolerance:** ±0.01 (currency precision)

| Field                       | Expected | Calculated | Difference | Within Tolerance? |
| --------------------------- | -------- | ---------- | ---------- | ----------------- |
| totalRecycled               | 7.50     | 7.50       | 0.00       | ✓ PASS            |
| exitsWithinPeriod           | 1        | 1          | 0          | ✓ PASS            |
| exitsAfterPeriod            | 0        | 0          | 0          | ✓ PASS            |
| recycledFromEligibleExits   | 7.50     | 7.50       | 0.00       | ✓ PASS            |
| returnedFromIneligibleExits | 0.00     | 0.00       | 0.00       | ✓ PASS            |
| fundProceeds                | 10.00    | 10.00      | 0.00       | ✓ PASS            |
| recycledAmount              | 7.50     | 7.50       | 0.00       | ✓ PASS            |
| returnedToLPs               | 2.50     | 2.50       | 0.00       | ✓ PASS            |

**Currency Precision:** All amounts in millions ($M), rounded to 2 decimal
places per tolerance spec.

**Tolerance Status:** ✓ PASS - All values exact (zero variance)

---

## 7. Invariant Checks

### INV-ER-015-1: Conservation of Capital

**Rule:** Fund proceeds = Recycled amount + Returned to LPs

**Verification:**

```
$10.0M (proceeds) = $7.5M (recycled) + $2.5M (returned)
$10.0M = $10.0M ✓
```

**Status:** ✓ PASS

### INV-ER-015-2: Inclusive Boundary Logic

**Rule:** Exit in year N of N-year period MUST be eligible (inclusive upper
bound)

**Verification:**

```
Exit year = 5
Recycling period = 5 years
Eligibility check: year <= period
                  5 <= 5 = TRUE ✓
Within period flag = true ✓
```

**Status:** ✓ PASS - Confirms inclusive boundary (NOT exclusive)

### INV-ER-015-3: Boundary vs. Overflow Distinction

**Rule:** Year N is within period, year (N+1) is after period

**Verification:**

```
Year 5 of 5-year period: withinPeriod = true ✓ (ER-015)
Year 6 of 5-year period: withinPeriod = false ✓ (would be ER-014 scenario)
Boundary correctly identifies last eligible year
```

**Status:** ✓ PASS

### INV-ER-015-4: Rate Application on Eligible Exits

**Rule:** Recycling rate applies ONLY to eligible exits (withinPeriod = true)

**Verification:**

```
Within period = true
Applied rate = 75% ✓
Recycled amount = $10M × 0.75 = $7.5M ✓
```

**Status:** ✓ PASS

### INV-ER-015-5: Exit Categorization Consistency

**Rule:** Sum of exits within + exits after MUST equal total exits

**Verification:**

```
Total exits = 1
Exits within period = 1
Exits after period = 0
1 = 1 + 0 ✓
```

**Status:** ✓ PASS

### INV-ER-015-6: Eligible vs. Ineligible Capital Segregation

**Rule:** Recycled from eligible + Returned from ineligible MUST NOT overlap

**Verification:**

```
Recycled from eligible exits = $7.5M (Exit-A eligible)
Returned from ineligible exits = $0M (no ineligible exits)
No overlap ✓
Total capital accounted for = $7.5M + $2.5M (LP distribution from eligible) = $10M ✓
```

**Status:** ✓ PASS

### INV-ER-015-7: Capacity Constraint Compliance

**Rule:** Total recycled MUST NOT exceed max recyclable capital

**Verification:**

```
Total recycled = $7.5M
Max recyclable capital = $15M
$7.5M < $15M ✓
Remaining capacity = $7.5M ✓
```

**Status:** ✓ PASS

### INV-ER-015-8: Applied Rate Consistency

**Rule:** Applied rate in recyclingByExit MUST match exit recycling rate for
eligible exits

**Verification:**

```
Exit recycling rate = 75%
Applied rate (Exit-A) = 75% ✓
Within period = true → rate applied as configured ✓
```

**Status:** ✓ PASS

---

## 8. Classification

**RESULT:** ✓ VALIDATED (Truth Case Confirmed - Boundary Condition Critical
Test)

**Evidence:**

1. **Arithmetic verification:** All calculations correct (0% variance)
2. **Tolerance compliance:** All values within ±0.01 tolerance (exact match)
3. **Invariant satisfaction:** 8/8 invariants pass
4. **Boundary logic:** Inclusive upper bound (year <= period) confirmed
5. **ADR alignment:** Behavior consistent with implicit inclusive boundary
   semantics

**Classification Rationale:**

- ER-015 is a **CRITICAL BOUNDARY TEST** validating inclusive period logic
- Tests that year N of N-year period IS eligible (not off-by-one error)
- Confirms correct implementation: `year <= recyclingPeriod` (NOT
  `year < recyclingPeriod`)
- Prevents subtle bug where "5-year period" would actually be 4 years
- Establishes precedent for boundary interpretation in related scenarios
  (ER-016, ER-017)

**Boundary Test Significance:**

- **ER-013:** Year 3 of 5 (clearly within) → baseline eligibility
- **ER-014:** Year 7 of 5 (clearly after) → baseline ineligibility
- **ER-015:** Year 5 of 5 (boundary) → **CRITICAL VALIDATION** of inclusive
  logic
- **ER-016:** Multiple exits with year 5 boundary → confirms boundary in complex
  scenarios

---

## 9. Notes and Observations

### 9.1 Boundary Condition Significance

**Why This Matters:**

- **Off-by-one prevention:** Most common bug in date/period logic is exclusive
  vs. inclusive boundaries
- **Semantic correctness:** "5-year recycling period" should mean exits in years
  1-5 are eligible, not years 1-4
- **Consistency with industry norms:** LP agreements specify inclusive periods
  (e.g., "first 5 years of fund life")
- **Cross-scenario validation:** ER-016 (mixed timing) relies on ER-015 boundary
  logic being correct

**Common Pitfall:**

```typescript
// INCORRECT (off-by-one error)
if (exitYear < recyclingPeriod) {
  // Year 5 of 5-year period would be ineligible
}

// CORRECT (inclusive boundary)
if (exitYear <= recyclingPeriod) {
  // Year 5 of 5-year period is eligible ✓
}
```

### 9.2 ADR Clarification Opportunity

**Suggested ADR-007 Amendment:**

Add to Section 2.X (Period Eligibility):

> **Boundary Semantics (Inclusive):** The recycling period is **inclusive** of
> the final year. An exit occurring in year N of an N-year recycling period is
> eligible for recycling. Formally:
> `withinPeriod = (exitYear <= recyclingPeriod)`.
>
> **Example:** For a 5-year recycling period starting in fund year 1:
>
> - Year 1: Eligible (1 <= 5) ✓
> - Year 5: Eligible (5 <= 5) ✓ (boundary year)
> - Year 6: Ineligible (6 > 5) ✗
>
> **Rationale:** Inclusive boundaries align with industry standard LP agreement
> language and prevent off-by-one errors in period calculations.

**Benefit:** Explicitly documents boundary semantics tested by ER-015,
preventing future implementation errors.

### 9.3 Implementation Considerations

**Code Implications:**

```typescript
// Boundary-safe period check
function isWithinRecyclingPeriod(
  exitYear: number,
  recyclingPeriod: number
): boolean {
  // CRITICAL: Use <= for inclusive boundary
  return exitYear <= recyclingPeriod;

  // INCORRECT: exitYear < recyclingPeriod
  // Would make year N of N-year period ineligible
}

// Unit test for boundary condition
test('ER-015: Year 5 of 5-year period is eligible (inclusive boundary)', () => {
  expect(isWithinRecyclingPeriod(5, 5)).toBe(true); // Boundary year
  expect(isWithinRecyclingPeriod(6, 5)).toBe(false); // After period
});
```

**Edge Case Handling:**

```typescript
// Additional boundary tests
test('Boundary edge cases', () => {
  // Year 1 is always eligible (lower bound)
  expect(isWithinRecyclingPeriod(1, 5)).toBe(true);

  // Year N is eligible (upper bound - CRITICAL)
  expect(isWithinRecyclingPeriod(5, 5)).toBe(true);

  // Year 0 or negative should be invalid (pre-condition)
  expect(isWithinRecyclingPeriod(0, 5)).toBe(false);

  // Year N+1 is ineligible (just past boundary)
  expect(isWithinRecyclingPeriod(6, 5)).toBe(false);
});
```

### 9.4 Related Scenarios

**Boundary Test Suite:**

- **ER-013:** Year 3 of 5-year period (within, not boundary)
- **ER-014:** Year 7 of 5-year period (after, not boundary)
- **ER-015:** Year 5 of 5-year period (boundary - CRITICAL)
- **ER-016:** Mixed exits including year 5 boundary (complex validation)
- **ER-017:** Year 2 of 2-year period (boundary with short period)

**Together these validate:**

- Lower bound (year 1 always eligible)
- Upper bound inclusive (year N of N-year period eligible)
- After period (year N+1 ineligible)
- Short period boundaries (2-year period)
- Long period boundaries (8-year period)

### 9.5 Integration with Multi-Period Scenarios

**ER-016 Dependency:** ER-016 (Mixed timing exits) includes an exit in year 5 of
5-year period alongside exits in years 2 and 7. ER-016's correctness **depends
on ER-015** validating boundary logic:

```json
// From ER-016
{
  "exitId": "Exit-B",
  "exitYear": 5, // Boundary year
  "fundProceeds": 8,
  "recycledAmount": 8,
  "returnedToLPs": 0,
  "withinPeriod": true, // Must be true per ER-015
  "appliedRate": 100
}
```

If ER-015 boundary logic were incorrect (exclusive), ER-016 would also fail,
cascading the error to complex scenarios.

---

## 10. Next Actions

### 10.1 Immediate Actions (Implementation Phase)

1. **Implement Inclusive Boundary Check:**

   ```typescript
   // In exit recycling engine
   function checkPeriodEligibility(
     exitYear: number,
     recyclingPeriod: number
   ): boolean {
     // CRITICAL: Inclusive upper bound
     return exitYear > 0 && exitYear <= recyclingPeriod;
   }
   ```

2. **Add Boundary Unit Tests:**

   ```typescript
   describe('Period Boundary Tests', () => {
     test('ER-015: Year N of N-year period is eligible (inclusive)', () => {
       const result = calculateRecycling({
         exitYear: 5,
         recyclingPeriod: 5,
         fundProceeds: 10_000_000,
         recyclingRate: 75,
       });

       expect(result.withinPeriod).toBe(true);
       expect(result.recycledAmount).toBe(7_500_000);
       expect(result.returnedToLPs).toBe(2_500_000);
     });

     test('Year N+1 of N-year period is ineligible', () => {
       const result = calculateRecycling({
         exitYear: 6,
         recyclingPeriod: 5,
         fundProceeds: 10_000_000,
         recyclingRate: 75,
       });

       expect(result.withinPeriod).toBe(false);
       expect(result.recycledAmount).toBe(0);
       expect(result.returnedToLPs).toBe(10_000_000);
     });
   });
   ```

3. **Validate Against Off-by-One Errors:**
   - Run ER-013 (year 3), ER-014 (year 7), ER-015 (year 5) as a suite
   - Confirm all three scenarios pass with same period logic
   - Verify boundary behavior is consistent across all period lengths

### 10.2 Documentation Actions

1. **Update ADR-007 (Exit Recycling Policy):**
   - Add Section 2.X: "Period Boundary Semantics (Inclusive)"
   - Document `year <= recyclingPeriod` logic explicitly
   - Provide examples of boundary years for common period lengths (2, 5, 8
     years)

2. **Add Developer Documentation:**
   ```typescript
   /**
    * Recycling Period Eligibility
    *
    * IMPORTANT: Period boundaries are INCLUSIVE. An exit in year N of an N-year
    * recycling period IS eligible for recycling.
    *
    * Correct: exitYear <= recyclingPeriod
    * Incorrect: exitYear < recyclingPeriod (off-by-one error)
    *
    * Examples:
    * - 5-year period: years 1-5 eligible, year 6+ ineligible
    * - 8-year period: years 1-8 eligible, year 9+ ineligible
    *
    * Test coverage: ER-015 (5-year boundary), ER-017 (2-year boundary)
    */
   ```

### 10.3 Validation Actions

1. **Run ER-015 Against Implementation:**
   - Execute test case after boundary logic implementation
   - Verify `withinPeriod: true` for year 5 of 5-year period
   - Confirm all 8 invariants pass in live code
   - Validate tolerance compliance (±0.01)

2. **Cross-Reference Boundary Test Suite:**
   - Run ER-013, ER-014, ER-015 sequentially
   - Verify consistent period logic across all three
   - Compare results to confirm boundary is inclusive, not exclusive

3. **Integration Testing:**
   - Run ER-016 (which includes year 5 boundary exit)
   - Verify ER-016 passes if ER-015 passes (dependency validation)
   - Confirm multi-exit scenarios handle boundaries correctly

### 10.4 Monitoring Actions

1. **Add Boundary Observability:**
   - Log when exits occur on period boundaries (years N, N+1)
   - Track percentage of exits in boundary years vs. mid-period
   - Alert if boundary year exits are unexpectedly ineligible (logic error)

2. **Period Configuration Audit:**
   - Validate all configured recycling periods are reasonable (1-10 years)
   - Warn if period = 0 or negative (invalid configuration)
   - Monitor for off-by-one errors in production data

### 10.5 Regression Prevention

1. **Boundary Regression Suite:**

   ```typescript
   // Add to CI/CD pipeline
   describe('Period Boundary Regression Suite', () => {
     test.each([
       [2, 2, true], // 2-year period, year 2 (boundary)
       [5, 5, true], // 5-year period, year 5 (boundary)
       [8, 8, true], // 8-year period, year 8 (boundary)
       [2, 3, false], // 2-year period, year 3 (after)
       [5, 6, false], // 5-year period, year 6 (after)
       [8, 9, false], // 8-year period, year 9 (after)
     ])(
       'Period %i years, exit year %i → eligible=%s',
       (period, year, expected) => {
         expect(isWithinRecyclingPeriod(year, period)).toBe(expected);
       }
     );
   });
   ```

2. **Code Review Checklist:**
   - [ ] Verify all period checks use `<=` (inclusive), not `<` (exclusive)
   - [ ] Confirm boundary tests (ER-015, ER-017) pass
   - [ ] Check for off-by-one errors in period calculations
   - [ ] Validate against ADR-007 boundary semantics

---

## 11. References

### 11.1 Source Documents

- **Truth Case File:** `docs/exit-recycling.truth-cases.json` (Line 608-646)
- **Schema:** `docs/schemas/exit-recycling-truth-case.schema.json`
- **ADR:** `docs/adr/ADR-008-capital-allocation-policy.md` (Section 2.5)
- **Related ADR:** `docs/adr/ADR-007-exit-recycling-policy.md` (hypothetical,
  boundary semantics)

### 11.2 Related Scenarios

**Boundary Test Suite:**

- **ER-013:** Within-period baseline (year 3 of 5-year period)
- **ER-014:** After-period baseline (year 7 of 5-year period)
- **ER-015:** Boundary test - CRITICAL (year 5 of 5-year period)
- **ER-016:** Mixed timing with boundary exit (years 2, 5, 7 of 5-year period)
- **ER-017:** Short period boundary (year 2 of 2-year period)
- **ER-018:** Long period boundary (implicit - year 8 of 8-year period)

**Rate Validation:**

- **ER-004:** 75% rate, mid-period (validates rate application separate from
  boundary)
- **ER-010:** 0% rate (edge case for rate, mid-period)

### 11.3 Implementation Files (Planned)

- **Exit Recycling Engine:** `client/src/core/recycling/ExitRecyclingEngine.ts`
- **Period Validator:** `client/src/core/recycling/PeriodValidator.ts`
- **Boundary Tests:**
  `client/src/core/recycling/__tests__/period-boundary.test.ts`

---

**Evidence Bundle Version:** 1.0.0 **Generated By:** Claude Code (Sonnet 4.5)
**Validation Method:** Arithmetic verification + Node computation + Boundary
logic analysis + Invariant checking **Classification:** VALIDATED (Truth Case
Confirmed - CRITICAL BOUNDARY TEST) **Boundary Semantics:** INCLUSIVE (year <=
recyclingPeriod)
