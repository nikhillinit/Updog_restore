# Session Learnings Report

**Session:** 2026-02-18 (updated -- second pass with full P4/P5 cycle synthesis)
**Sources Analyzed:** 12 (5 plan files, 5 session reports, CHANGELOG, DECISIONS,
session-context, MEMORY.md) **Existing Reflections:** REFL-001 through REFL-023

## Learning Candidates

### Candidate 1: Integration Test Environment Leakage (5-Layer Defense)

- **Score:** 7 (repeated pattern +3, production impact +2, DX friction +1,
  security +1)
- **Source:** `tests/integration/setup.ts`, commits `ee51ae96`, `687a9a89`,
  `3cb593e8`
- **Category:** Infrastructure / Testing
- **Anti-Pattern:** Server modules that register Prometheus metrics, configure
  Express middleware, or read `process.env` at import time compound across
  Vitest workers -- duplicate metric registration, port conflicts, stale env
  vars. Each layer silently corrupts test state. Distinct from REFL-001 (dynamic
  imports) and REFL-007 (global vi.mock) because the root cause is import-time
  side effects in server infrastructure, not test configuration.
- **Fix (5-layer defense):**
  1. `sanitizeSecrets()` in setup.ts wipes real credentials
  2. `_EXPLICIT_*` env markers distinguish test from production env
  3. Ephemeral port `0` instead of hardcoded `3333` avoids port conflicts
  4. `getOrCreate` metrics pattern (REFL-022) prevents duplicate registration
  5. `database-mock.ts` rewritten to avoid importing real DB modules
- **Related:** REFL-001, REFL-007, REFL-022
- **Recommendation:** CREATE REFLECTION (REFL-024) -- composite pattern, not
  covered by individual REFLs

### Candidate 2: CI Compilation Boundary Mismatch

- **Score:** 5 (repeated pattern +3, DX friction +1, CI breakage +1)
- **Source:** P4, P5 pushes; pre-push hook failures across multiple sessions;
  commit `d1f903f7`
- **Category:** Infrastructure / TypeScript
- **Anti-Pattern:** `npx tsc --noEmit` passes locally (single unified
  compilation), but `npm run baseline:check` compiles `client/`, `server/`, and
  `shared/` as separate TypeScript projects. The separated compilation catches
  TS4111 (index signature access via bracket notation on
  `noUncheckedIndexedAccess` types) and cross-project type visibility issues
  that the unified check misses.
- **Fix:** Always run `npm run baseline:check` before pushing. Never trust
  `npx tsc --noEmit` alone.
- **Status:** In MEMORY.md but recurs every push cycle
- **Recommendation:** CREATE REFLECTION (REFL-025) -- MEMORY.md note is terse; a
  full reflection with examples would prevent recurring surprise

### Candidate 3: Prometheus Metrics Duplicate Registration on Hot Reload

- **Score:** 6 (repeated pattern +3, production impact +2, DX friction +1)
- **Source:** `server/metrics.ts:9-28`, commit `687a9a89`
- **Category:** Infrastructure
- **Anti-Pattern:** `new promClient.Counter()` at module top-level causes
  "metric already registered" on reimport. Affected 5 files.
- **Fix:** `getOrCreate` factory -- check `register.getSingleMetric(name)`
  before creating.
- **Recommendation:** DONE -- REFL-022 created

### Candidate 4: Math.random in Production Code (Security)

- **Score:** 5 (security +2, repeated pattern +3)
- **Source:** commits `1f973ad4`, `cc29d9a1`
- **Category:** Security
- **Anti-Pattern:** `Math.random().toString(36)` for runtime IDs in production
  paths. Not cryptographically secure.
- **Fix:** `crypto.randomUUID()` or remove fallback when primary crypto path
  exists.
- **Recommendation:** DONE -- REFL-023 created

### Candidate 5: Workflow Abandonment Under Pressure

- **Score:** 4 (repeated pattern +3, process debt +1)
- **Source:** 2026-01-20 hook-fix session, P4/P5 rapid iteration
- **Category:** Process / Meta
- **Anti-Pattern:** When fixes fail repeatedly, structured workflow (Codex
  consultation, findings.md updates, planning-with-files) gets abandoned in
  favor of rapid `Fix-Test-Fail-Fix` loops without documentation.
- **Fix:** Treat workflow tools as NON-OPTIONAL checkpoints. After every failed
  attempt: (1) update findings.md, (2) consult Codex, (3) plan next approach
  before retrying.
- **Recommendation:** SKIP -- process pattern. Added as MEMORY.md reminder
  instead.

### Candidate 6: Phantom Dependencies (Dead Imports of Uninstalled Packages)

- **Score:** 3 (DX friction +1, repeated pattern +2)
- **Source:** P4.5 findings -- `react-beautiful-dnd` imported but not in
  `package.json`
- **Category:** Infrastructure / Dependencies
- **Fix:** Already removed in P4.5. ESLint `import/no-unresolved` would catch
  future instances.
- **Recommendation:** SKIP -- one-off, already fixed

### Candidate 7: Feature Flag System Proliferation

- **Score:** 5 (repeated pattern +3, architecture debt +2)
- **Source:** P4 plan, P5.2 migration work
- **Category:** Architecture
- **Fix:** Standardized on `useUnifiedFlag` + YAML registry + generated types.
  Old `useFeatureFlag` deprecated via `no-restricted-imports`. Legacy
  `feature-flags.ts` deleted (284 lines).
- **Recommendation:** SKIP -- resolved in P5.2, ESLint guard prevents regression

## Summary of Actions

| #   | Action                                                                  | Status         |
| --- | ----------------------------------------------------------------------- | -------------- |
| 1   | Create REFL-024: Integration Test Environment Leakage (5-Layer Defense) | DONE           |
| 2   | Create REFL-025: CI Compilation Boundary Mismatch                       | DONE           |
| 3   | REFL-022: Prometheus Metrics Duplicate Registration                     | DONE           |
| 4   | REFL-023: Math.random in Production Identifiers                         | DONE           |
| 5   | Workflow Abandonment -- add MEMORY.md reminder                          | SKIP (process) |
| 6   | Phantom Dependencies -- one-off fix                                     | SKIP           |
| 7   | Feature Flag Proliferation -- ESLint guard active                       | SKIP           |

## Cross-Session Trend Analysis

| Pattern                                 | First Seen | Sessions         | Status                             |
| --------------------------------------- | ---------- | ---------------- | ---------------------------------- |
| Metrics/registry duplicate registration | P4.5       | 3 sessions       | REFL-022 DONE                      |
| Integration test isolation failures     | Phase0     | 4 sessions       | Candidate 1 (REFL-024 recommended) |
| CI vs local compilation mismatch        | P4         | Every push cycle | Candidate 2 (REFL-025 recommended) |
| Dead/phantom imports                    | P4.5       | 2 sessions       | One-off fix                        |
| Linter strips imports on edit hook      | P1         | Ongoing          | MEMORY.md                          |
| TypeScript array index narrowing        | P1         | 2 sessions       | MEMORY.md                          |

## P5 Tech Debt Snapshot (Context)

| Metric                         | Count                                                 |
| ------------------------------ | ----------------------------------------------------- |
| Tests passing / skipped        | 2,884 / 213                                           |
| eslint-disable no-explicit-any | 130 files                                             |
| `as any` / `: any` inline      | 76 occurrences, 30 files                              |
| console.log in client          | 45 occurrences, 15 files                              |
| TODO/FIXME/HACK in source      | 80+                                                   |
| Guardrail baselines active     | 2 (console ratchet: 374, eslint-disable ratchet: 132) |
