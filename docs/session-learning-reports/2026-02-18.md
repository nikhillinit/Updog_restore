# Session Learnings Report

**Session:** 2026-02-18 **Sources Analyzed:** 12 (P4 plan, P4.5
findings/progress, P5 findings/progress/plan, P5 baseline,
integration-test-phase0 findings, priority-planning findings, 8 recent commits,
session-context, 21 existing reflections)

## Learning Candidates

### Candidate 1: Prometheus Metrics Duplicate Registration on Hot Reload

- **Score:** 6 (repeated pattern +3, production impact +2, DX friction +1)
- **Source:** server/metrics.ts:9-28, commit 687a9a89
- **Category:** Infrastructure
- **Anti-Pattern:** Creating `new promClient.Counter()` / `Gauge()` /
  `Histogram()` at module top-level causes "metric already registered" errors
  when the module is reimported during test hot-reload or integration test
  setup. Multiple files scattered metrics creation: `server/metrics.ts`,
  `server/observability/performance-metrics.ts`,
  `server/metrics/variance-metrics.ts`, `server/lib/error-budget.ts`,
  `server/observability/lp-metrics.ts`.
- **Fix:** `getOrCreate` factory pattern -- check
  `register.getSingleMetric(name)` before creating. Refactored all 5 files to
  use `getOrCreateCounter`, `getOrCreateGauge`, `getOrCreateHistogram` helpers.
  Single `register` instance exported from `server/metrics.ts`.
- **Recommendation:** CREATE REFLECTION (REFL-022)

### Candidate 2: Math.random in Production Code (Security)

- **Score:** 5 (security implication +2, repeated pattern +3 -- found in 2
  files)
- **Source:** commits 1f973ad4, cc29d9a1
- **Category:** Security
- **Anti-Pattern:** Using `Math.random().toString(36)` to generate runtime IDs
  or fallback identifiers in production code paths (`rollout-runtime.ts`).
  `Math.random()` is not cryptographically secure and produces predictable
  values.
- **Fix:** Replace with `crypto.randomUUID()` or `crypto.getRandomValues()`. In
  this case, the `Math.random` fallback was removed entirely since the primary
  `crypto.randomUUID()` path was already present.
- **Recommendation:** CREATE REFLECTION (REFL-023)

### Candidate 3: Integration Test Environment Leakage

- **Score:** 5 (repeated pattern +3, DX friction +1, production impact +1)
- **Source:** tests/integration/setup.ts, commits ee51ae96, 687a9a89, 3cb593e8
- **Category:** Infrastructure
- **Anti-Pattern:** Integration tests import server modules that register
  Prometheus metrics, configure Express middleware, or read `process.env` at
  import time. When multiple test files run in the same Vitest worker, these
  side effects compound -- duplicate metric registration, port conflicts, stale
  env vars.
- **Fix:** Multi-layer defense: (1) `sanitizeSecrets()` in setup.ts to normalize
  env before any import, (2) `_EXPLICIT_*` env markers to distinguish test-set
  vs leaked values, (3) ephemeral port `0` instead of hardcoded `3333`, (4)
  `getOrCreate` metrics pattern, (5) database-mock.ts rewritten to avoid
  importing real DB modules.
- **Recommendation:** UPDATE EXISTING (partially covered by REFL-001 dynamic
  imports + REFL-007 global mock pollution, but env leakage is a distinct
  sub-pattern)

### Candidate 4: CI Baseline Stricter Than Local tsc

- **Score:** 4 (repeated pattern +3, DX friction +1)
- **Source:** commit d1f903f7, MEMORY.md existing note
- **Category:** Infrastructure
- **Anti-Pattern:** `npx tsc --noEmit` passes locally but CI's "Unified
  TypeScript baseline" check compiles `client`, `server`, and `shared` as
  separate TS projects, catching cross-project errors (TS4111 index signature
  access, import resolution differences). Developers push code believing it
  compiles, then CI fails.
- **Fix:** Already documented in MEMORY.md. The formal pattern: run
  `npm run baseline:check` locally before pushing, not just `npx tsc --noEmit`.
- **Recommendation:** SKIP -- already captured in MEMORY.md. Could promote to
  REFL if it recurs.

### Candidate 5: Phantom Dependencies in package.json

- **Score:** 3 (DX friction +1, repeated pattern (2 instances) +2)
- **Source:** P4.5 findings (react-beautiful-dnd imported but not installed)
- **Category:** Infrastructure
- **Anti-Pattern:** Code imports a library (`react-beautiful-dnd`) that is not
  in `package.json`. Works in dev if hoisted from a transitive dep or never
  executed. Breaks on clean install or when the transitive dep updates.
- **Fix:** Grep for imports, cross-reference with `package.json` dependencies.
  Remove dead imports or install the package. In P4.5, the import was dead code
  and was removed.
- **Recommendation:** SKIP -- low frequency, one-off cleanup

### Candidate 6: Feature Flag System Proliferation

- **Score:** 4 (DX friction +1, repeated pattern +3)
- **Source:** P4 plan (3 competing flag systems found), P5 findings (deprecated
  flag references)
- **Category:** State
- **Anti-Pattern:** Three separate feature flag systems coexisted:
  `useFeatureFlag`, `useUnifiedFlag`, and a direct YAML reader. Different
  components used different systems, causing inconsistent behavior and making it
  impossible to audit flag usage from a single source.
- **Fix:** Standardized on `useUnifiedFlag` + YAML registry + generated types.
  Old systems marked deprecated with migration path. P5 plan (P5.2) includes
  removal of deprecated flag code.
- **Recommendation:** SKIP -- already handled by P5.2 plan and flag migration is
  documented in DECISIONS.md

### Candidate 7: Guardrail Baselines as Ratchet Mechanism

- **Score:** 4 (DX friction +1, production impact +2, new pattern +1)
- **Source:** docs/plans/p5-debt-baseline-2026-02-17.md
- **Category:** Infrastructure
- **Anti-Pattern:** Tech debt metrics (console.log count, eslint-disable count,
  quarantine count) were only tracked informally. No mechanism to prevent
  regression -- new code could add console.logs or eslint-disables without
  anyone noticing.
- **Fix:** `.baselines/` JSON files with `npm run guardrails:check` that fails
  if counts exceed baseline. Ratchet pattern: baselines only decrease, never
  increase. Pre-push hook validates.
- **Recommendation:** SKIP -- pattern is fresh and may evolve. Revisit after P5
  execution.

## Actions

1. [x] Create REFL-022 for "Prometheus Metrics Duplicate Registration on Hot
       Reload"
2. [x] Create REFL-023 for "Math.random in Production Code"
3. [ ] Update REFL-001 or REFL-007 with integration test env leakage sub-pattern
       (Candidate 3)
4. [x] Skip Candidate 4 -- already in MEMORY.md
5. [x] Skip Candidate 5 -- one-off cleanup
6. [x] Skip Candidate 6 -- handled by P5.2 plan
7. [x] Skip Candidate 7 -- pattern too fresh, revisit post-P5

## Cross-Session Patterns Observed

| Pattern                                 | Sessions             | Trend                             |
| --------------------------------------- | -------------------- | --------------------------------- |
| Metrics/registry duplicate registration | P4.5, P5, CI fixes   | Recurring -- needs REFL           |
| Integration test isolation failures     | Phase0, P5, CI fixes | Recurring -- partially documented |
| CI vs local compilation mismatch        | P4, P5, every push   | Chronic -- documented in MEMORY   |
| Dead/phantom imports                    | P4.5, P5 findings    | Moderate -- tooling gap           |
