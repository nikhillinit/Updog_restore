# Session Learnings Report: January 1-7, 2026

**Generated:** 2026-01-18
**Date Range:** 2026-01-01 to 2026-01-07
**Sessions Analyzed:** 15 largest sessions (40MB+ conversation data)
**Topics Identified:** TypeScript errors, CI/CD issues, cache implementation, testing patterns

---

## Major Topics from This Period

1. **TypeScript Error Resolution** - Systematic reduction from 437 → 8 errors
2. **ScenarioMatrixCache Implementation** - Dual-tier Redis/PostgreSQL caching
3. **CI/CD Discovery Routing** - Cross-platform CRLF/LF issues
4. **Integration Test Infrastructure** - Phase 3 testcontainers work
5. **Monte Carlo Power Law MOIC** - Statistical calibration issues

---

## Learning Candidates

### Candidate 1: Global vi.mock() Pollutes All Tests
- **Score:** 6/10 (repeated pattern +3, DX friction +2, debugging time +1)
- **Source:** Conversation analysis - database-mock.ts issue
- **Category:** Testing
- **Anti-Pattern:** Global `vi.mock()` in a shared file gets applied to ALL tests, even those that don't import it
- **Fix:** Use factory functions instead of global mocks; keep mocks scoped to individual test files
- **Recommendation:** CREATE REFLECTION

### Candidate 2: TypeScript Type Inference from Database Schemas
- **Score:** 5/10 (repeated pattern +3, DX friction +2)
- **Source:** 70b88dcb session - ScenarioMatrixCache type errors
- **Category:** TypeScript
- **Anti-Pattern:** Assuming interface shapes without checking actual Drizzle schema inference
- **Fix:** Always check actual generated types from `typeof schema.$inferSelect`; don't guess field names
- **Recommendation:** CREATE REFLECTION

### Candidate 3: Redis Method Naming (setex vs setEx)
- **Score:** 3/10 (DX friction +2, easy fix +1)
- **Source:** 70b88dcb session - Redis mock issues
- **Category:** Infrastructure
- **Anti-Pattern:** Using lowercase `setex` when `node-redis` v4+ uses camelCase `setEx`
- **Fix:** Check library version and use correct method casing
- **Recommendation:** SKIP (too specific)

### Candidate 4: CRLF Line Endings Break Frontmatter Parsing
- **Score:** 5/10 (cross-platform +3, CI impact +2)
- **Source:** CI routing discovery - parseFrontmatter() regex
- **Category:** Infrastructure
- **Anti-Pattern:** Regex only matching `\n` (LF), not `\r\n` (CRLF) for frontmatter parsing
- **Fix:** Use `/\r?\n/` pattern or normalize line endings before parsing
- **Recommendation:** CREATE REFLECTION

### Candidate 5: Stale Background Processes Give False Positives
- **Score:** 4/10 (DX friction +2, debugging time +2)
- **Source:** 70b88dcb session - "13 new TypeScript errors" that were stale
- **Category:** Infrastructure
- **Anti-Pattern:** Trusting output from background processes that may be showing stale state
- **Fix:** Always verify current state with fresh command before acting on background process output
- **Recommendation:** CREATE REFLECTION

### Candidate 6: Pre-Commit Hooks Block Emergency Fixes
- **Score:** 4/10 (production impact +2, workflow friction +2)
- **Source:** CI routing session - force push to bypass hooks
- **Category:** Workflow
- **Anti-Pattern:** Strict pre-commit hooks with no escape hatch for urgent fixes
- **Fix:** Document `git commit --no-verify` for emergencies; add hook bypass documentation
- **Recommendation:** SKIP (workflow, not code)

### Candidate 7: Trust Proxy Configuration for Rate Limiters
- **Score:** 5/10 (security +2, production impact +2, repeated +1)
- **Source:** Session analyzing rate limiter failures
- **Category:** Security
- **Anti-Pattern:** Not configuring `trust proxy` when behind reverse proxy, causing rate limiter to see wrong IPs
- **Fix:** Configure `app.set('trust proxy', 1)` when behind load balancer/proxy
- **Recommendation:** CREATE REFLECTION

### Candidate 8: Statistical Test Calibration Formulas
- **Score:** 5/10 (financial calculation +3, correctness +2)
- **Source:** PowerLawMOIC implementation
- **Category:** Math
- **Anti-Pattern:** Using raw ratios (10/2) instead of percentile ratios (P90/P50 = 0.9/0.5) for statistical calibration
- **Fix:** Use proper statistical percentile calculations for distribution fitting
- **Recommendation:** CREATE REFLECTION

### Candidate 9: Converting Failing Tests to Skipped Tests
- **Score:** 3/10 (test coverage +2, DX +1)
- **Source:** approval-guard.test.ts fix
- **Category:** Testing
- **Anti-Pattern:** Keeping tests that fail due to infrastructure issues
- **Fix:** Convert infrastructure-dependent failing tests to skipped with clear reason; don't let them block CI
- **Recommendation:** SKIP (already documented in test-pyramid skill)

### Candidate 10: Composite Index Optimization Timing
- **Score:** 3/10 (performance +2, DX +1)
- **Source:** Database optimization review
- **Category:** Database
- **Anti-Pattern:** Adding composite indexes without query analysis
- **Fix:** Profile actual queries before adding indexes; measure before/after
- **Recommendation:** SKIP (general DB best practice)

---

## Summary

| Candidate | Score | Action |
|-----------|-------|--------|
| 1. Global vi.mock() Pollution | 6 | CREATE REFLECTION |
| 2. TypeScript Type Inference | 5 | CREATE REFLECTION |
| 3. Redis Method Naming | 3 | SKIP |
| 4. CRLF Frontmatter Parsing | 5 | CREATE REFLECTION |
| 5. Stale Background Processes | 4 | CREATE REFLECTION |
| 6. Pre-Commit Hook Bypass | 4 | SKIP |
| 7. Trust Proxy Configuration | 5 | CREATE REFLECTION |
| 8. Statistical Calibration Formulas | 5 | CREATE REFLECTION |
| 9. Failing → Skipped Tests | 3 | SKIP |
| 10. Composite Index Timing | 3 | SKIP |

---

## Actions

1. [ ] Create REFL-007 for "Global vi.mock() Pollutes All Tests"
2. [ ] Create REFL-008 for "TypeScript Type Inference from Database Schemas"
3. [ ] Create REFL-009 for "CRLF Line Endings Break Frontmatter Parsing"
4. [ ] Create REFL-010 for "Stale Background Processes Give False Positives"
5. [ ] Create REFL-011 for "Trust Proxy Configuration for Rate Limiters"
6. [ ] Create REFL-012 for "Statistical Calibration Formulas for Distribution Fitting"

---

## Session Themes

### Week 1 Focus Areas
1. **Phase 3 Integration Tests** - Major push on testcontainers and cache monitoring
2. **TypeScript Baseline** - Systematic error reduction campaign
3. **CI Stability** - Discovery routing and cross-platform compatibility
4. **Cache Architecture** - ScenarioMatrixCache dual-tier implementation
