{
  "dashboard": {
    "title": "Fund Operations Dashboard",
    "tags": ["funds", "operations", "idempotency"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
        "title": "Fund Creation Success Rate",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\",status=~\"2..\"}[5m])) / sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[5m])) * 100",
            "legendFormat": "Success Rate %"
          }
        ],
        "type": "graph",
        "yaxes": [{ "format": "percent", "min": 0, "max": 100 }]
      },
      {
        "id": 2,
        "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
        "title": "409 Conflict Rate (Idempotency)",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",status=\"409\"}[5m]))",
            "legendFormat": "409 Conflicts/sec"
          }
        ],
        "type": "graph",
        "alert": {
          "conditions": [
            {
              "evaluator": { "params": [0.1], "type": "gt" },
              "query": { "params": ["A", "5m", "now"] },
              "reducer": { "params": [], "type": "avg" },
              "type": "query"
            }
          ],
          "name": "High 409 Conflict Rate"
        }
      },
      {
        "id": 3,
        "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
        "title": "Fund Creation P95 Latency",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[5m])))",
            "legendFormat": "p95 Latency"
          },
          {
            "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[5m])))",
            "legendFormat": "p99 Latency"
          }
        ],
        "type": "graph",
        "yaxes": [{ "format": "s", "min": 0 }],
        "thresholds": [
          {
            "value": 0.5,
            "color": "rgba(237, 129, 40, 0.89)",
            "fill": true,
            "line": true
          },
          {
            "value": 2.0,
            "color": "rgba(245, 54, 54, 0.9)",
            "fill": true,
            "line": true
          }
        ]
      },
      {
        "id": 4,
        "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
        "title": "Fund Creation Request Volume",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[5m]))",
            "legendFormat": "Total Requests/sec"
          },
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\",status=~\"2..\"}[5m]))",
            "legendFormat": "Successful/sec"
          },
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\",status=\"409\"}[5m]))",
            "legendFormat": "409 Conflicts/sec"
          },
          {
            "expr": "sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\",status=~\"5..\"}[5m]))",
            "legendFormat": "Errors/sec"
          }
        ],
        "type": "graph",
        "stack": false
      },
      {
        "id": 5,
        "gridPos": { "x": 0, "y": 16, "w": 8, "h": 4 },
        "title": "Current Fund Count",
        "targets": [
          {
            "expr": "count(funds_total{job=\"fund-calc-api\"})",
            "legendFormat": "Total Funds"
          }
        ],
        "type": "stat",
        "format": "short"
      },
      {
        "id": 6,
        "gridPos": { "x": 8, "y": 16, "w": 8, "h": 4 },
        "title": "Idempotency Effectiveness",
        "targets": [
          {
            "expr": "(sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",status=\"409\"}[24h])) / sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[24h]))) * 100",
            "legendFormat": "Duplicate Prevention %"
          }
        ],
        "type": "stat",
        "format": "percent",
        "thresholds": {
          "mode": "absolute",
          "steps": [
            { "color": "green", "value": null },
            { "color": "yellow", "value": 5 },
            { "color": "red", "value": 10 }
          ]
        }
      },
      {
        "id": 7,
        "gridPos": { "x": 16, "y": 16, "w": 8, "h": 4 },
        "title": "SLO Compliance (99.9%)",
        "targets": [
          {
            "expr": "(1 - (sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\",status=~\"5..\"}[24h])) / sum(rate(http_requests_total{job=\"fund-calc-api\",endpoint=\"/api/funds\",method=\"POST\"}[24h])))) * 100",
            "legendFormat": "Availability %"
          }
        ],
        "type": "gauge",
        "format": "percent",
        "min": 95,
        "max": 100,
        "thresholds": {
          "mode": "absolute",
          "steps": [
            { "color": "red", "value": 95 },
            { "color": "yellow", "value": 99 },
            { "color": "green", "value": 99.9 }
          ]
        }
      }
    ],
    "refresh": "10s",
    "time": { "from": "now-6h", "to": "now" },
    "timepicker": {
      "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h"],
      "time_options": ["5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d"]
    },
    "version": 1
  }
}
