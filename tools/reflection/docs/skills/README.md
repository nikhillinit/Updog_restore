# Team Memory: The Reflection System

This directory contains the Updog_restore repository's "Team Memory"â€”a collection of reflections that capture critical lessons learned, especially those related to financial logic, architectural patterns, and bug prevention.

**The goal of this system is to prevent logic regressions and to ensure that hard-won knowledge is codified and automatically shared with developers at the moment they need it.**

## Guiding Principles

1.  **Codify, Don't Just Document:** Plain documentation goes stale. Reflections are machine-readable and integrated into the development workflow.
2.  **Prevent, Don't Just Detect:** The system is designed to proactively warn developers *before* they implement a known anti-pattern.
3.  **Automate and Enforce:** The index is auto-generated, and validation is run in CI to prevent drift and ensure integrity.
4.  **Fail Loud:** Financial systems must not fail silently. Reflections and their corresponding tests enforce this principle.

## Core Components

-   **Reflections (`REFL-*.md`):** Individual markdown files, each capturing a single lesson. They describe an anti-pattern, its risks, and the verified, production-ready fix.
-   **Index (`SKILLS_INDEX.md`):** An auto-generated, machine-readable index of all reflections. **Do not edit this file manually.**
-   **Manager Script (`scripts/manage_skills.py`):** The Python script used to create, validate, and index reflections.
-   **Regression Tests (`tests/regressions/`):** Every `VERIFIED` reflection is backed by a regression test that proves the fix and prevents the anti-pattern.

## Developer Workflow

This system is integrated into your daily workflow through a set of commands and automated checks.

### Before You Code: The `/advise` Command

If you are about to work on a high-risk area (e.g., waterfalls, reserves, fees), ask for guidance first:

```bash
/advise "I am about to implement the GP catch-up logic for a European waterfall."
```

Claude will consult the `SKILLS_INDEX.md` and provide you with a pre-flight checklist of relevant constraints and anti-patterns to avoid.

### After You Fix a Bug: The `/retrospective` Command

If you've just fixed a bug that represents a valuable lesson, codify it immediately.

```bash
/retrospective --title "GP Catch-up Logic Fails on Zero IRR"
```

This command will:
1.  Create a new reflection file (e.g., `docs/skills/REFL-004-gp-catch-up-logic-fails-on-zero-irr.md`).
2.  Create a corresponding test file stub (e.g., `tests/regressions/REFL-004.test.ts`).
3.  Automatically rebuild the `SKILLS_INDEX.md`.

Your job is to then fill in the details of the reflection and the test.

### Committing a Fix: The `/commit` Command

When you commit a fix, the system will automatically prompt you if it detects a learning opportunity.

```bash
/commit -m "fix: Corrected waterfall distribution for zero IRR scenarios"
```

Claude will analyze the message and conversation history. If it looks like a bug fix, it will ask:

> This appears to be a fix. Create reflection? (y/n/later)

This ensures that lessons are captured at the moment they are learned.

## Managing Reflections

All management is handled by the `manage_skills.py` script.

### Creating a New Reflection

```bash
python3 scripts/manage_skills.py new --title "Your New Reflection Title"
```

This is the preferred way to create new reflections as it guarantees a unique ID and creates all the necessary files.

### Rebuilding the Index

The index is automatically rebuilt when you create a new reflection. You can also trigger it manually:

```bash
python3 scripts/manage_skills.py rebuild
```

A pre-commit hook is configured to run this automatically, so you should rarely need to do it by hand.

### Validating the System

To ensure the integrity of the entire reflection database (unique IDs, required fields, test file existence, index freshness), run the validation command. This is also part of the CI pipeline.

```bash
python3 scripts/manage_skills.py validate
```

This command will exit with a non-zero status code if any errors are found, making it a reliable gate in CI/CD.
