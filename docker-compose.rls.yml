version: '3.8'

services:
  # PostgreSQL Primary with RLS
  postgres-primary:
    image: postgres:14-alpine
    container_name: updog-postgres-primary
    environment:
      POSTGRES_DB: updog
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_ADMIN_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --data-checksums"
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - maintenance_work_mem=128MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=16MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=8MB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB
      - -c
      - wal_level=logical
      - -c
      - max_wal_senders=10
      - -c
      - max_replication_slots=10
      - -c
      - hot_standby=on
      - -c
      - hot_standby_feedback=on
      - -c
      - ssl=on
      - -c
      - ssl_cert_file=/var/lib/postgresql/server.crt
      - -c
      - ssl_key_file=/var/lib/postgresql/server.key
      - -c
      - shared_preload_libraries=pg_stat_statements
      - -c
      - pg_stat_statements.track=all
      - -c
      - pg_stat_statements.max=10000
      - -c
      - row_security=on
      - -c
      - plan_cache_mode=force_custom_plan
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./certs/postgres:/var/lib/postgresql
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - updog-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Read Replica
  postgres-replica:
    image: postgres:14-alpine
    container_name: updog-postgres-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_ADMIN_PASSWORD}
      POSTGRES_PRIMARY_HOST: postgres-primary
      POSTGRES_PRIMARY_PORT: 5432
      POSTGRES_PRIMARY_USER: replicator
      POSTGRES_PRIMARY_PASSWORD: ${REPLICATOR_PASSWORD}
    command:
      - postgres
      - -c
      - hot_standby=on
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
      - ./scripts/database/setup-replica.sh:/docker-entrypoint-initdb.d/setup-replica.sh
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - updog-network

  # PgBouncer Connection Pooler
  pgbouncer:
    image: pgbouncer/pgbouncer:1.21.0
    container_name: updog-pgbouncer
    environment:
      DATABASES_HOST: postgres-primary
      DATABASES_PORT: 5432
      DATABASES_DBNAME: updog
      DATABASES_POOL_MODE: transaction
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 5
      SERVER_RESET_QUERY: DISCARD ALL
      SERVER_RESET_QUERY_ALWAYS: 1
      AUTH_TYPE: scram-sha-256
    volumes:
      - ./config/pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./config/pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
      - ./certs/pgbouncer:/etc/pgbouncer/certs:ro
    ports:
      - "6432:6432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - updog-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HAProxy Load Balancer
  haproxy:
    image: haproxy:2.8-alpine
    container_name: updog-haproxy
    volumes:
      - ./config/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5433:5433"  # Read connections
      - "8404:8404"  # Stats page
    depends_on:
      - postgres-primary
      - postgres-replica
    networks:
      - updog-network
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Exporter for Prometheus
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.13.2
    container_name: updog-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://updog_monitor:${MONITOR_DB_PASSWORD}@postgres-primary:5432/updog?sslmode=require"
      PG_EXPORTER_EXTEND_QUERY_PATH: /etc/postgres_exporter/queries.yaml
    volumes:
      - ./monitoring/postgres-exporter-queries.yaml:/etc/postgres_exporter/queries.yaml:ro
    ports:
      - "9187:9187"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - updog-network

  # PgBouncer Exporter for Prometheus
  pgbouncer-exporter:
    image: prometheuscommunity/pgbouncer-exporter:v0.7.0
    container_name: updog-pgbouncer-exporter
    environment:
      DATABASE_URL: "postgresql://pgbouncer_admin:${PGBOUNCER_ADMIN_PASSWORD}@pgbouncer:6432/pgbouncer?sslmode=disable"
    ports:
      - "9127:9127"
    depends_on:
      pgbouncer:
        condition: service_healthy
    networks:
      - updog-network

  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: updog-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=30d'
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - updog-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:10.0.0
    container_name: updog-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
      GF_SERVER_ROOT_URL: http://localhost:3000
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - updog-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Alert Manager
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: updog-alertmanager
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    ports:
      - "9093:9093"
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - updog-network

  # Redis for Application Caching and Queues
  redis:
    image: redis:7-alpine
    container_name: updog-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - updog-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Application Backend (with RLS context)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: updog-app
    environment:
      NODE_ENV: production
      DATABASE_URL: "postgresql://updog_app:${APP_DB_PASSWORD}@pgbouncer:6432/updog?schema=public"
      REDIS_URL: "redis://default:${REDIS_PASSWORD}@redis:6379"
      JWT_SECRET: ${JWT_SECRET}
      PORT: 5000
    ports:
      - "5000:5000"
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - updog-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres-data:
  postgres-replica-data:
  prometheus-data:
  grafana-data:
  alertmanager-data:
  redis-data:

networks:
  updog-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16