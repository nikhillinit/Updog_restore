#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

# Robust check for docs-only commits
UPSTREAM=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")
if [ -z "$UPSTREAM" ]; then
  # No upstream - check staged files
  CHANGED=$(git diff --cached --name-only)
else
  # Has upstream - check changes since upstream
  CHANGED=$(git diff --name-only "$UPSTREAM"...HEAD 2>/dev/null || git diff --cached --name-only)
fi

# Skip heavy checks for docs-only changes
if echo "$CHANGED" | grep -qE '^(docs/|README|CHANGELOG|LICENSE|.*\.(md|txt))$'; then
  echo "ğŸ“š Docs-only changes detected - skipping heavy checks"
  exit 0
fi

echo "ğŸ” Running pre-push checks..."

# Fast checks that prevent bad pushes
echo "  â†’ Smoke tests..."
npm run test:smoke --silent || {
  echo "âŒ Smoke tests failed"
  exit 1
}

echo "  â†’ Bundle size check..."
npm run bundle:check --silent || {
  echo "âŒ Bundle exceeds 350KB limit"
  exit 1
}

echo "  â†’ Type checking..."
npx tsc --noEmit || {
  echo "âŒ TypeScript errors detected"
  exit 1
}

echo "âœ… All pre-push checks passed!"
