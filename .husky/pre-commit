#!/usr/bin/env sh

echo "[PRE-COMMIT] Running checks..."

# Check for emoji in staged files (exclude legacy CHANGELOG and emoji documentation)
echo "[CHECK] Scanning for emojis..."
EMOJI_FILES=$(git diff --cached --name-only | grep -E '\.(md|js|mjs|ts|tsx|jsx)$' | grep -v -E '(CHANGELOG\.md|cheatsheets/emoji-free-documentation\.md|HANDOFF-|PROJECT-PHOENIX-COMPREHENSIVE-STRATEGY\.md|\.claude/agents/)' || true)
if [ -n "$EMOJI_FILES" ]; then
  if echo "$EMOJI_FILES" | xargs grep -l -P '[\x{1F000}-\x{1FAFF}]' 2>/dev/null; then
    echo "[FAIL] Emoji found in staged files (excluding legacy CHANGELOG and emoji docs)."
    echo "See CLAUDE.md for approved replacements."
    exit 1
  fi
  # Special check for CLAUDE.md - only allow emoji in the replacement table and examples
  if echo "$EMOJI_FILES" | grep -q "CLAUDE.md"; then
    if git diff --cached CLAUDE.md | grep '^+' | grep -v -E '(Instead of|Use|\| |grep|`.*emoji.*`)' | grep -P '[\x{1F000}-\x{1FAFF}]' 2>/dev/null; then
      echo "[FAIL] Emoji found outside allowed sections in CLAUDE.md"
      exit 1
    fi
  fi
fi

# Check for bigint type safety in Zod schemas
echo "[CHECK] Validating bigint type safety..."
SCHEMA_FILES=$(git diff --cached --name-only | grep -E 'shared/schemas/.*\.ts$' || true)
if [ -n "$SCHEMA_FILES" ]; then
  if echo "$SCHEMA_FILES" | xargs grep -n 'version.*z\.number()' 2>/dev/null; then
    echo "[FAIL] Version fields must use z.bigint() or z.string(), not z.number()"
    echo "Database uses BIGINT for version columns to prevent precision loss."
    echo "Use helper schemas from shared/schemas/common.ts:"
    echo "  - DbVersionBigIntSchema (for native bigint)"
    echo "  - DbVersionSchema (for string transport)"
    exit 1
  fi
  # Check for common bigint field patterns
  if echo "$SCHEMA_FILES" | xargs grep -n -E '(.*_id|.*Id).*z\.number\(\)\.int\(\).*positive\(\)' 2>/dev/null | grep -v -E '(fundId|companyId|investmentId|userId)'; then
    echo "[WARN] Potential bigint field using z.number() - verify database column type is INTEGER, not BIGINT"
  fi
fi


npx lint-staged

# Optional: AI code review (set AI_REVIEW_ENABLED=1 to enable)
if [ "$AI_REVIEW_ENABLED" = "1" ]; then
  echo "[AI-REVIEW] Running AI code review..."
  python ai-utils/scripts/review_staged.py --quick || echo "[WARN] AI review found issues (not blocking)"
fi

echo "[PASS] Pre-commit checks passed"