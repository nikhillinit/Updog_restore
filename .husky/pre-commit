#!/usr/bin/env sh

echo "[PRE-COMMIT] Running checks..."

# Check for emoji in staged files (exclude legacy CHANGELOG and emoji documentation)
echo "[CHECK] Scanning for emojis..."
EMOJI_FILES=$(git diff --cached --name-only | grep -E '\.(md|js|mjs|ts|tsx|jsx)$' | grep -v -E '(CHANGELOG\.md|cheatsheets/emoji-free-documentation\.md|HANDOFF-)' || true)
if [ -n "$EMOJI_FILES" ]; then
  if echo "$EMOJI_FILES" | xargs grep -l -P '[\x{1F000}-\x{1FAFF}]' 2>/dev/null; then
    echo "[FAIL] Emoji found in staged files (excluding legacy CHANGELOG and emoji docs)."
    echo "See CLAUDE.md for approved replacements."
    exit 1
  fi
  # Special check for CLAUDE.md - only allow emoji in the replacement table and examples
  if echo "$EMOJI_FILES" | grep -q "CLAUDE.md"; then
    if git diff --cached CLAUDE.md | grep '^+' | grep -v -E '(Instead of|Use|\| |grep|`.*emoji.*`)' | grep -P '[\x{1F000}-\x{1FAFF}]' 2>/dev/null; then
      echo "[FAIL] Emoji found outside allowed sections in CLAUDE.md"
      exit 1
    fi
  fi
fi

npx lint-staged

# Optional: AI code review (set AI_REVIEW_ENABLED=1 to enable)
if [ "$AI_REVIEW_ENABLED" = "1" ]; then
  echo "[AI-REVIEW] Running AI code review..."
  python ai-utils/scripts/review_staged.py --quick || echo "[WARN] AI review found issues (not blocking)"
fi

echo "[PASS] Pre-commit checks passed"