name: CI Unified
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_full_suite:
        description: 'Run full test suite (ignore smart selection)'
        required: false
        type: boolean
        default: false
      enable_security:
        description: 'Run security tests'
        required: false
        type: boolean
        default: false
      enable_memory_mode:
        description: 'Run memory mode tests'
        required: false
        type: boolean
        default: false
      run_alert_drills:
        description: 'Run alert validation drills'
        required: false
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  # Phase 1: Detect changes for smart test selection
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      # Simplified boolean outputs - dorny/paths-filter returns 'true'/'false' strings
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      affected_tests: ${{ steps.affected.outputs.tests || 'all' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Required for accurate change detection

      - name: Detect changed file paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          # Output format: 'true'/'false' strings for each filter
          filters: |
            code:
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '**/*.jsx'
              - 'package*.json'
              - 'package-lock.json'
              - '.github/workflows/**'
              - 'server/**'
              - 'client/**'
              - 'shared/**'
              - 'scripts/**'
              - '!scripts/validation/**'
              - 'tests/**'
            docs:
              - '**/*.md'
              - 'docs/**'
              - '.github/*.md'
              - 'scripts/validation/**'
              - '!CHANGELOG.md'

      - name: Detect affected tests
        id: affected
        if: github.event_name == 'pull_request' && steps.filter.outputs.code == 'true'
        run: |
          # Smart test detection - only run tests affected by changes
          AFFECTED=$(node scripts/test-smart.mjs --list-only 2>/dev/null || echo "all")
          echo "tests=${AFFECTED}" >> $GITHUB_OUTPUT

  # Phase 2: Setup and compile TypeScript once with caching
  setup:
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event.inputs.run_full_suite == 'true'
    name: Setup & Build Cache
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Generate cache key
        id: cache-key
        run: |
          echo "key=tsc-${{ hashFiles('**/*.ts', '**/*.tsx', '**/tsconfig*.json', 'package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Cache TypeScript build
        id: tsc-cache
        uses: actions/cache@v4
        with:
          path: |
            .tsbuildinfo.*
            **/*.tsbuildinfo
            node_modules/.cache
            coverage/
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            tsc-

      - name: Install dependencies (retry on transient network failure)
        run: |
          npm ci --prefer-offline --no-audit || \
          npm ci --prefer-offline --no-audit || \
          npm ci --prefer-offline --no-audit

      - name: TypeScript baseline check
        run: |
          # Use baseline checking to allow baselined errors (482 known errors in .tsc-baseline.json)
          # This prevents CI failures from pre-existing type issues while enforcing no new errors
          npm run baseline:check

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tsbuild
          path: |
            .tsbuildinfo.*
            **/*.tsbuildinfo
          retention-days: 1

  # Phase 3: Parallel checks (type checking and linting)
  check:
    name: Check ${{ matrix.job }}
    needs: [changes, setup]
    if: needs.changes.outputs.code == 'true' || github.event.inputs.run_full_suite == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        job: [client, server, shared, lint, unit-fast]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Restore TypeScript cache
        uses: actions/cache@v4
        with:
          path: |
            .tsbuildinfo.*
            **/*.tsbuildinfo
            node_modules/.cache
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies (retry on transient network failure)
        run: |
          npm ci --prefer-offline --no-audit || \
          npm ci --prefer-offline --no-audit || \
          npm ci --prefer-offline --no-audit

      - name: Download build artifacts (best effort)
        id: download_tsbuild
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tsbuild

      - name: Retry build artifact download on transient network failure
        if: steps.download_tsbuild.outcome == 'failure'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tsbuild

      - name: Run check
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          case "${{ matrix.job }}" in
            client|server|shared)
              # Use baseline checking instead of raw tsc to respect .tsc-baseline.json
              # This prevents CI failures from the 482 baselined errors while catching new issues
              npm run baseline:check
              ;;
            lint)
              npm run lint
              ;;
            unit-fast)
              npm run test:unit -- --bail=1 --reporter=dot || npm run test:quick
              ;;
          esac

  # Phase 4A: Smart test execution for PRs
  test-affected:
    name: Test (Affected Only)
    needs: [changes, check]
    if: |
      github.event_name == 'pull_request' && 
      needs.changes.outputs.code == 'true' &&
      github.event.inputs.run_full_suite != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Cache test results
        uses: actions/cache@v4
        with:
          path: |
            coverage/
            .vitest-cache/
          key: test-affected-${{ github.sha }}
          restore-keys: |
            test-affected-

      - run: npm ci --prefer-offline --no-audit

      - name: Setup database
        run: npm run db:push
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Run affected tests
        run: |
          npm run test:affected || npm run test:smart || npm run test:quick
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          TZ: UTC

  # Phase 4B: Full test matrix for main branch
  test-full:
    name: Test ${{ matrix.group }}
    needs: [changes, check]
    if: |
      (github.ref == 'refs/heads/main' || github.event.inputs.run_full_suite == 'true') &&
      needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - group: unit
            needs-db: false
            needs-redis: false
          - group: integration
            needs-db: true
            needs-redis: true
          - group: e2e
            needs-db: true
            needs-redis: true

    services:
      postgres:
        image: ${{ matrix.needs-db && 'postgres:16-alpine' || '' }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: ${{ matrix.needs-redis && 'redis:7-alpine' || '' }}
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Cache test results
        uses: actions/cache@v4
        with:
          path: |
            coverage/
            .vitest-cache/
          key: test-${{ matrix.group }}-${{ github.sha }}
          restore-keys: |
            test-${{ matrix.group }}-

      - run: npm ci --prefer-offline --no-audit

      - name: Setup database
        if: matrix.needs-db
        run: npm run db:push
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Install Playwright
        if: matrix.group == 'e2e'
        run: npx playwright install --with-deps chromium

      - name: Run tests
        run: |
          case "${{ matrix.group }}" in
            unit)
              npm run test:unit
              ;;
            integration)
              npm run test:integration
              ;;
            e2e)
              npm run test:e2e:smoke || npm run test:smoke
              ;;
          esac
        env:
          NODE_ENV: test
          DATABASE_URL: ${{ matrix.needs-db && 'postgresql://postgres:postgres@localhost:5432/test' || '' }}
          REDIS_URL: ${{ matrix.needs-redis && 'redis://localhost:6379' || '' }}
          TZ: UTC

  # Phase 5: Build validation with dynamic bundle guard
  build:
    name: Build Production
    needs: [setup, check]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - run: npm ci --prefer-offline --no-audit

      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production

      - name: Bundle size check
        run: npm run bundle:check || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

  # Conditional: Security tests (label or input triggered)
  security-tests:
    name: Security Tests
    needs: [changes, setup]
    if: |
      contains(fromJson(toJson(github.event.pull_request.labels)).*.name, 'run:security') ||
      github.event.inputs.enable_security == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - run: npm ci --prefer-offline --no-audit

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run security tests
        if: hashFiles('tests/security/**/*.test.ts') != ''
        run: npm run test:security || vitest run tests/security
        continue-on-error: true

      - name: OWASP dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'updog'
          path: '.'
          format: 'HTML'
        continue-on-error: true

  # Conditional: Memory mode tests
  memory-mode:
    name: Memory Mode Tests
    needs: [changes, setup]
    if: |
      (github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[memory]')) ||
      github.event.inputs.enable_memory_mode == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - run: npm ci --prefer-offline --no-audit

      - name: Run memory mode tests
        run: |
          npm run test:memory
          npm run verify:no-redis
        env:
          REDIS_URL: memory://
          ENABLE_QUEUES: 0

  # Alert validation drills
  alert-drills:
    name: Alert Validation Drills
    if: github.event.inputs.run_alert_drills == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9090:9090
        options: >-
          --mount type=bind,source=${{ github.workspace }}/monitoring/prometheus.yml,target=/etc/prometheus/prometheus.yml,readonly
          --mount type=bind,source=${{ github.workspace }}/monitoring/alerts,target=/etc/prometheus/alerts,readonly
      alertmanager:
        image: prom/alertmanager:latest
        ports:
          - 9093:9093
        options: >-
          --mount type=bind,source=${{ github.workspace }}/monitoring/alertmanager.yml,target=/etc/alertmanager/alertmanager.yml,readonly
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - run: npm ci --prefer-offline --no-audit

      - name: Start test environment
        run: |
          npm run dev:api &
          npx wait-on http://localhost:5000/api/health --timeout 60000

      - name: Run alert drills
        run: |
          node scripts/alert-drill-runner.js \
            lcpBreach \
            inpBreach \
            rumRejectHigh

      - name: Verify alerts fired
        run: |
          node scripts/verify-alerts.js \
            --alerts LCPBudgetFastBurn,INPBudgetFastBurn,RUMIngestRejectRatioHigh \
            --require

      - name: Upload drill results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alert-drill-results
          path: |
            alert-drill-results.json
            alert-verification-results.json

  # Governance guards
  guards:
    name: Governance Guards
    needs: changes
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Badge URLs
        run: |
          echo "üîç Validating badge references..."

          # Use same filtering as badge-audit script
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const IGNORE_PATTERNS = [
            /```[\s\S]*?```/g,
            /~~~[\s\S]*?~~~/g,
            /<!--[\s\S]*?-->/g,
            /`[^`]*workflows[^`]*`/g,
            /workflows\/\*[^\/\)]*\.yml/g
          ];

          function cleanContent(content) {
            let cleaned = content;
            IGNORE_PATTERNS.forEach(pattern => {
              cleaned = cleaned.replace(pattern, '');
            });
            return cleaned;
          }

          const BADGE_PATTERN = /workflows\/([^\/\)]+\.yml)/g;

          let broken = [];

          function scanDir(dir) {
            fs.readdirSync(dir, {withFileTypes: true}).forEach(entry => {
              const fullPath = path.join(dir, entry.name);

              // Skip node_modules, archive dirs (historical docs), and _archive
              const skipDirs = ['node_modules', 'archive', '_archive'];
              if (entry.isDirectory() && !skipDirs.some(s => entry.name.includes(s))) {
                scanDir(fullPath);
              } else if (entry.isFile() && entry.name.endsWith('.md')) {
                const content = fs.readFileSync(fullPath, 'utf8');
                const cleaned = cleanContent(content);

                const matches = [...cleaned.matchAll(BADGE_PATTERN)];
                matches.forEach(match => {
                  const workflow = match[1];
                  if (!fs.existsSync(`.github/workflows/${workflow}`)) {
                    broken.push({file: fullPath, workflow});
                  }
                });
              }
            });
          }

          scanDir('.');

          if (broken.length > 0) {
            console.log('[FAIL] Found broken badge references:');
            broken.forEach(b => console.log(`  ${b.file}: workflows/${b.workflow}`));
            process.exit(1);
          }

          console.log('[PASS] All badge references valid');
          EOF

      - name: Feature flags guard
        id: flags-guard
        run: |
          PR_LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}' \
          node scripts/flags-guard.mjs
        continue-on-error: true

      - name: Check for perf budget changes
        id: perf-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.perf-budget.json
            **/perf-budget.*

      - name: Performance budget guard
        id: perf-guard
        if: steps.perf-files.outputs.any_changed == 'true'
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          HAS_APPROVAL=$(echo "$LABELS" | jq -r 'map(select(.name == "approved:perf-budget-change")) | length > 0')
          if [[ "$HAS_APPROVAL" != "true" ]]; then
            echo "[FAIL] Performance budget changes require 'approved:perf-budget-change' label"
            exit 1
          fi

      - name: Comment guard results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const flagsBlocked = "${{ steps.flags-guard.outcome }}" === "failure";
            const perfBlocked = "${{ steps.perf-guard.outcome }}" === "failure";

            if (flagsBlocked || perfBlocked) {
              let comment = "## [BLOCKED] Governance Guards\n\n";
              if (flagsBlocked) comment += "[FAIL] **Feature flags changes blocked** - requires approval labels\n";
              if (perfBlocked) comment += "[FAIL] **Performance budget changes blocked** - requires approval\n";
              comment += "\nSee job logs for details.";
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

  # Final gate status
  gate:
    name: CI Gate Status
    needs: [check, test-affected, test-full, build, guards]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Determine gate status
        id: status
        run: |
          # For PRs, check test-affected; for main, check test-full
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEST_RESULT="${{ needs.test-affected.result }}"
          else
            TEST_RESULT="${{ needs.test-full.result }}"
          fi

          if [[ "${{ needs.check.result }}" != "success" || 
                "$TEST_RESULT" != "success" || 
                "${{ needs.build.result }}" != "success" ]]; then
            echo "CI Gate Failed"
            echo "Check: ${{ needs.check.result }}"
            echo "Test: $TEST_RESULT"
            echo "Build: ${{ needs.build.result }}"
            exit 1
          fi
          echo "[PASS] CI Gate Passed"

      - name: Comment PR status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = "${{ steps.status.outcome }}";
            const statusIcon = status === "success" ? "[PASS]" : "[FAIL]";
            const testType = "${{ needs.test-affected.result }}" ? "affected" : "full";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${statusIcon} **CI Summary**
              - Checks: ${{ needs.check.result }}
              - Tests (${testType}): ${{ needs.test-affected.result || needs.test-full.result || 'skipped' }}
              - Build: ${{ needs.build.result }}
              `
            });
