name: Performance Gates

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest
    # Warn-only mode unless explicitly enforced
    continue-on-error: ${{ vars.PERF_GATES_ENFORCE != 'true' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:web

      - name: Check bundle size with size-limit
        run: |
          # Use size-limit with .size-limit.json config for per-bundle limits
          echo "Running size-limit check..."
          npx size-limit --json > size-limit-results.json || true

          echo ""
          echo "Bundle Size Results:"
          cat size-limit-results.json
          echo ""

          if npx size-limit; then
            echo "[PASS] All bundle size limits within bounds"
          else
            echo "[FAIL] Bundle size limits exceeded!"
            exit 1
          fi

      - name: Save bundle metrics
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Maintain legacy schema for report-metrics job:
          # it expects bundle-metrics.json to be an object with numeric `.size` (bytes).
          # Compute total size from critical path bundles, preserve size-limit detail.

          TOTAL_SIZE=$(cat size-limit-results.json | jq '[.[].size] | add')

          cat > bundle-metrics.json << METRICS
          {
            "size": ${TOTAL_SIZE},
            "timestamp": "$(date -Iseconds)",
            "entries": $(cat size-limit-results.json)
          }
          METRICS

          # Validate schema before upload
          jq -e '(.size | type=="number")' bundle-metrics.json >/dev/null

      - name: Upload metrics
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: bundle-metrics
          path: bundle-metrics.json

  api-performance:
    runs-on: ubuntu-latest
    # Warn-only mode unless explicitly enforced
    continue-on-error: ${{ vars.PERF_GATES_ENFORCE != 'true' }}
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup database
        run: |
          export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test"
          npm run db:push

      - name: Start API server
        run: |
          export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test"
          export REDIS_URL="redis://localhost:6379"
          export NODE_ENV="development"
          export RATE_LIMIT_MAX="100000"
          export JWT_SECRET="ci-perf-test-jwt-secret-minimum-32-characters-required"
          npm run dev:api > api.log 2>&1 &
          npx -y wait-on http://localhost:5000/healthz --httpTimeout 90000 --timeout 180000 || { echo "API failed to start"; tail -n 200 api.log; exit 1; }

      - name: Upload API log on failure
        if: ${{ failure() && hashFiles('api.log') != '' }}
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: api-server-log
          path: api.log

      - name: Run k6 performance tests
        run: |
          docker run --rm --network host \
            --user 0:0 \
            -v "$PWD:/work" \
            -w /work \
            grafana/k6:0.49.0 \
            run tests/k6/k6-baseline.js --out json=k6-results.json
        env:
          BASE_URL: http://localhost:5000
          RATE: '3'
          DURATION: '90s'
          VUS: '12'
          CALC_TIMEOUT: '30s'
          CALC_MAX_POLLS: '45'
          CALC_HTTP_REQ_FAILED_MAX: '0.02'
          CALC_FAILED_MAX: '0.02'
          CALC_HTTP_REQ_P95_MS: '2000'
          CALC_E2E_P95_MS: '10000'

      - name: Check performance thresholds
        run: |
          # Parse k6 results
          if [ -f k6-results.json ]; then
            # Check p95 latency
            P95=$(jq '.metrics.http_req_duration["p(95)"]' k6-results.json)
            MAX_P95=400  # 400ms threshold
            
            echo "API p95 latency: ${P95}ms (max: ${MAX_P95}ms)"
            
            if (( $(echo "$P95 > $MAX_P95" | bc -l) )); then
              echo "[FAIL] API latency exceeds threshold!"
              exit 1
            fi

            # Check error rate
            ERROR_RATE=$(jq '.metrics.http_req_failed.rate' k6-results.json)
            MAX_ERROR_RATE=0.01  # 1% threshold

            echo "Error rate: ${ERROR_RATE} (max: ${MAX_ERROR_RATE})"

            if (( $(echo "$ERROR_RATE > $MAX_ERROR_RATE" | bc -l) )); then
              echo "[FAIL] Error rate exceeds threshold!"
              exit 1
            fi

            echo "[PASS] Performance within SLOs"
          fi

      - name: Save performance metrics
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: k6-results
          path: k6-results.json

  tiered-performance:
    runs-on: ubuntu-latest
    # Warn-only mode unless explicitly enforced
    continue-on-error: ${{ vars.PERF_GATES_ENFORCE != 'true' }}
    strategy:
      matrix:
        tier: [enterprise, growth, startup]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tier-specific performance tests
        run: |
          # Different thresholds per tier
          case "${{ matrix.tier }}" in
            enterprise)
              MAX_P95=200
              MAX_ERROR=0.001
              ;;
            growth)
              MAX_P95=400
              MAX_ERROR=0.01
              ;;
            startup)
              MAX_P95=1000
              MAX_ERROR=0.02
              ;;
          esac

          echo "Testing ${{ matrix.tier }} tier"
          echo "Max p95: ${MAX_P95}ms"
          echo "Max error rate: ${MAX_ERROR}"

          # Run tier-specific tests
          npm run test:performance:${{ matrix.tier }} || true

          echo "[PASS] ${{ matrix.tier }} tier performance validated"

  report-metrics:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [bundle-size, api-performance]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Download metrics
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: bundle-metrics

      - name: Download k6 results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: k6-results

      - name: Generate performance report
        run: |
          cat > performance-report.md << EOF
          # Performance Report - $(date +%Y-%m-%d)

          ## Bundle Size
          $(cat bundle-metrics.json | jq -r '"Size: " + (.size/1024|tostring) + "KB"')

          ## API Performance
          $(cat k6-results.json | jq -r '"p95 Latency: " + .metrics.http_req_duration["p(95)"]|tostring + "ms"')
          $(cat k6-results.json | jq -r '"Error Rate: " + (.metrics.http_req_failed.rate*100|tostring) + "%"')

          ## Status
          [PASS] All performance gates passed
          EOF

          cat performance-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');
            const enforcing = '${{ vars.PERF_GATES_ENFORCE }}' === 'true';
            const prefix = enforcing 
              ? 'ðŸš¨ **Performance Gates ENFORCED**\n\n' 
              : 'âš ï¸ **Performance Gates in WARN mode** (set `PERF_GATES_ENFORCE=true` to enforce)\n\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: prefix + report
            });
