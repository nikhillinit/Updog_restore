name: File Hygiene Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-forbidden-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for forbidden files
        run: |
          echo "Checking for forbidden files in PR..."
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
          
          # Define forbidden patterns
          FORBIDDEN_PATTERNS=(
            "*.log"
            "*.tmp"
            ".env"
            ".env.*"
            "*.tsbuildinfo"
            ".tscache"
          )
          
          # Check each changed file
          FOUND_FORBIDDEN=false
          FORBIDDEN_FILES=()
          
          for file in $CHANGED_FILES; do
            for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
              case "$file" in
                $pattern)
                  echo "❌ Found forbidden file: $file (matches pattern: $pattern)"
                  FORBIDDEN_FILES+=("$file")
                  FOUND_FORBIDDEN=true
                  ;;
              esac
            done
          done
          
          if [ "$FOUND_FORBIDDEN" = true ]; then
            echo ""
            echo "❌ PR contains forbidden files that should not be committed:"
            printf '%s\n' "${FORBIDDEN_FILES[@]}"
            echo ""
            echo "Please remove these files from your commit and add them to .gitignore if needed."
            echo ""
            echo "Common solutions:"
            echo "- git rm --cached <file> (to remove from git but keep locally)"
            echo "- Add the pattern to .gitignore"
            echo "- Use environment-specific config files instead of .env"
            exit 1
          else
            echo "✅ No forbidden files found in this PR"
          fi