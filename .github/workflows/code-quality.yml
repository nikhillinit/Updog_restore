name: Code Quality Gate

on:
  pull_request:
    branches: [main, develop, 'recovery/**']
  push:
    branches: [main, develop]

# Centralized configuration for quality thresholds
env:
  # Critical thresholds (fail build)
  MAX_TS_ERRORS: 0
  MAX_ESLINT_ERRORS: 0

  # Warning thresholds (alert only)
  WARNING_ANY_TYPES: 5000
  WARNING_ESLINT_DISABLE: 1500

  # Informational thresholds
  INFO_STRICT_MODE_ERRORS: 100

  # Source directories to analyze
  SOURCE_DIRS: 'client/ server/ shared/'
  FILE_PATTERNS: '*.ts *.tsx'

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with auto-fix
        id: eslint
        run: |
          set +e  # Don't exit on error
          npm run lint:fix
          npm run lint > eslint-results.txt 2>&1
          LINT_EXIT_CODE=$?

          if [ $LINT_EXIT_CODE -ne 0 ]; then
            echo "LINT_FAILED=true" >> $GITHUB_ENV
          fi

          exit 0  # Don't fail the step
        continue-on-error: true

      - name: TypeScript type check
        id: typecheck
        run: |
          set +e  # Don't exit on error
          npm run check > typecheck-results.txt 2>&1
          TYPECHECK_EXIT_CODE=$?

          if [ $TYPECHECK_EXIT_CODE -ne 0 ]; then
            echo "TYPECHECK_FAILED=true" >> $GITHUB_ENV
          fi

          exit 0  # Don't fail the step
        continue-on-error: true

      - name: Count code quality metrics
        id: metrics
        run: |
          # Initialize metrics report
          cat > metrics-report.md << 'EOF'
          ## Code Quality Metrics

          EOF

          # Count 'any' types (more accurate regex)
          ANY_COUNT=$(grep -rE ":\s*any\b" $SOURCE_DIRS --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || echo "0")
          echo "ANY_COUNT=$ANY_COUNT" >> $GITHUB_ENV
          echo "- **Any types**: $ANY_COUNT (threshold: < ${{ env.WARNING_ANY_TYPES }})" >> metrics-report.md

          # Count eslint-disable comments (all variants)
          DISABLE_COUNT=$(grep -rE "eslint-disable(-next-line|-line)?" $SOURCE_DIRS --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || echo "0")
          echo "DISABLE_COUNT=$DISABLE_COUNT" >> $GITHUB_ENV
          echo "- **ESLint-disable comments**: $DISABLE_COUNT (threshold: < ${{ env.WARNING_ESLINT_DISABLE }})" >> metrics-report.md

          # Count TypeScript errors (more robust parsing)
          TS_ERRORS=$(grep -c "error TS" typecheck-results.txt 2>/dev/null || echo "0")
          echo "TS_ERRORS=$TS_ERRORS" >> $GITHUB_ENV
          echo "- **TypeScript errors**: $TS_ERRORS (threshold: = ${{ env.MAX_TS_ERRORS }})" >> metrics-report.md

          # Count ESLint issues (improved parsing)
          LINT_ISSUES=$(grep -oP '\d+(?= problems?)' eslint-results.txt 2>/dev/null | head -1 || echo "0")
          echo "LINT_ISSUES=$LINT_ISSUES" >> $GITHUB_ENV
          echo "- **ESLint issues**: $LINT_ISSUES (threshold: = ${{ env.MAX_ESLINT_ERRORS }})" >> metrics-report.md

          # Add status indicators
          cat >> metrics-report.md << EOF

          ### Status Summary

          | Metric | Current | Threshold | Status |
          |--------|---------|-----------|--------|
          | TypeScript Errors | $TS_ERRORS | ≤ ${{ env.MAX_TS_ERRORS }} | $([ "$TS_ERRORS" -le "${{ env.MAX_TS_ERRORS }}" ] && echo "PASS" || echo "FAIL") |
          | ESLint Issues | $LINT_ISSUES | ≤ ${{ env.MAX_ESLINT_ERRORS }} | $([ "${LINT_FAILED:-false}" = "false" ] && echo "PASS" || echo "FAIL") |
          | Any Types | $ANY_COUNT | < ${{ env.WARNING_ANY_TYPES }} | $([ "$ANY_COUNT" -lt "${{ env.WARNING_ANY_TYPES }}" ] && echo "Good" || echo "WARNING") |
          | ESLint-disable | $DISABLE_COUNT | < ${{ env.WARNING_ESLINT_DISABLE }} | $([ "$DISABLE_COUNT" -lt "${{ env.WARNING_ESLINT_DISABLE }}" ] && echo "Good" || echo "WARNING") |
          EOF

      - name: Check quality thresholds
        id: threshold-check
        run: |
          FAILED=0
          WARNINGS=0

          echo "### Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Critical checks (fail build)
          if [ "${TYPECHECK_FAILED:-false}" = "true" ] || [ "${TS_ERRORS:-0}" -gt "${{ env.MAX_TS_ERRORS }}" ]; then
            echo "**CRITICAL**: TypeScript type check failed (${TS_ERRORS:-0} errors)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          if [ "${LINT_FAILED:-false}" = "true" ]; then
            echo "**CRITICAL**: ESLint check failed (${LINT_ISSUES:-0} issues)" | tee -a $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Warning checks (don't fail build)
          if [ "${ANY_COUNT:-0}" -ge "${{ env.WARNING_ANY_TYPES }}" ]; then
            echo "**WARNING**: 'any' types (${ANY_COUNT:-0}) exceed threshold (${{ env.WARNING_ANY_TYPES }})" | tee -a $GITHUB_STEP_SUMMARY
            WARNINGS=$((WARNINGS + 1))
          fi

          if [ "${DISABLE_COUNT:-0}" -ge "${{ env.WARNING_ESLINT_DISABLE }}" ]; then
            echo "**WARNING**: eslint-disable comments (${DISABLE_COUNT:-0}) exceed threshold (${{ env.WARNING_ESLINT_DISABLE }})" | tee -a $GITHUB_STEP_SUMMARY
            WARNINGS=$((WARNINGS + 1))
          fi

          # Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $FAILED -eq 0 ] && [ $WARNINGS -eq 0 ]; then
            echo "SUCCESS: All quality gates passed!" >> $GITHUB_STEP_SUMMARY
          elif [ $FAILED -eq 0 ]; then
            echo "Quality gates passed with $WARNINGS warning(s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "FAILED: Quality gate failed. Please fix the issues above." >> $GITHUB_STEP_SUMMARY
          fi

          # Exit with appropriate code
          exit $FAILED

      - name: Generate auto-fix suggestions
        if: failure()
        run: |
          cat > fixes-report.md << 'EOF'
          ## Suggested Fixes

          ### Automated Fixes Available

          Run these commands locally to fix issues:

          ```bash
          # Auto-fix ESLint issues
          npm run lint:fix

          # Run type checking to see detailed errors
          npm run check

          # Run tests to verify fixes
          npm run test:quick
          ```

          ### Manual Review Required

          EOF

          # Add specific guidance based on failures
          if [ "${TS_ERRORS:-0}" -gt 0 ]; then
            cat >> fixes-report.md << 'EOF'
          **TypeScript Errors**: Review type definitions and fix type mismatches.
          - Check `typecheck-results.txt` artifact for detailed error messages
          - Consider using stricter types instead of `any`
          - Ensure all imports are properly typed

          EOF
          fi

          if [ "${LINT_FAILED:-false}" = "true" ]; then
            cat >> fixes-report.md << 'EOF'
          **ESLint Issues**: Review and fix linting violations.
          - Check `eslint-results.txt` artifact for detailed issues
          - Run `npm run lint:fix` to auto-fix formatting issues
          - Manually address logic and best practice violations

          EOF
          fi

      - name: Comment PR with metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read metrics report
            const metrics = fs.existsSync('metrics-report.md')
              ? fs.readFileSync('metrics-report.md', 'utf8')
              : '## WARNING: No metrics available';

            // Read fixes report if it exists
            const fixes = fs.existsSync('fixes-report.md') 
              ? '\n\n' + fs.readFileSync('fixes-report.md', 'utf8')
              : '';

            const body = `${metrics}${fixes}`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Quality Metrics')
            );

            // Update existing or create new comment
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Upload quality reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            metrics-report.md
            fixes-report.md
            eslint-results.txt
            typecheck-results.txt
          retention-days: 30
          if-no-files-found: warn

  type-safety-check:
    name: Type Safety Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run strict TypeScript check
        run: |
          echo "Running strict TypeScript configuration..."

          set +e  # Don't exit on error
          npx tsc --project tsconfig.strict.json --noEmit > strict-check.txt 2>&1
          TSC_EXIT_CODE=$?

          STRICT_ERRORS=$(grep -c "error TS" strict-check.txt 2>/dev/null || echo "0")
          echo "Strict mode errors: $STRICT_ERRORS"

          # Add to job summary
          echo "### Strict Type Safety Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Errors in strict mode**: $STRICT_ERRORS" >> $GITHUB_STEP_SUMMARY

          if [ "$STRICT_ERRORS" -gt "${{ env.INFO_STRICT_MODE_ERRORS }}" ]; then
            echo "**NOTE**: $STRICT_ERRORS errors found in strict mode (informational only)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This check is informational and does not block the build." >> $GITHUB_STEP_SUMMARY
            echo "Consider gradually addressing these to improve type safety." >> $GITHUB_STEP_SUMMARY
          else
            echo "PASS: Strict mode errors within acceptable range" >> $GITHUB_STEP_SUMMARY
          fi

          exit 0  # Always succeed for informational check

      - name: Analyze 'any' type usage
        run: |
          cat > any-analysis.md << 'EOF'
          ## 'any' Type Analysis

          ### Top 10 Files with 'any' Types

          EOF

          # Find and analyze files with most 'any' types
          if grep -rE ":\s*any\b" ${{ env.SOURCE_DIRS }} --include="*.ts" --include="*.tsx" 2>/dev/null | \
             cut -d: -f1 | sort | uniq -c | sort -rn | head -10 > /tmp/any-files.txt; then
            
            awk '{print "- `" $2 "`: " $1 " occurrence(s)"}' /tmp/any-files.txt >> any-analysis.md
            
            # Add recommendations
            cat >> any-analysis.md << 'EOF'

          ### Recommendations

          - Replace `any` with specific types where possible
          - Use `unknown` for values with truly unknown types (safer than `any`)
          - Consider using type guards for type narrowing
          - Add proper type definitions for third-party libraries
          EOF
          else
            echo "PASS: No files with 'any' types found" >> any-analysis.md
          fi

      - name: Upload type safety reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-safety-reports
          path: |
            strict-check.txt
            any-analysis.md
          retention-days: 30
          if-no-files-found: warn
