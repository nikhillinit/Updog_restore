name: Dependency Validation
on: [push, pull_request]

jobs:
  validate:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: ['20.19.0']
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Upgrade npm to match packageManager
        shell: bash
        run: npm install -g npm@10.9.2

      - name: Toolchain Sanity Check
        shell: bash
        run: |
          node -v | grep 20.19.0
          npm -v | grep 10.9.2

      - name: Disable Husky in CI
        shell: bash
        run: git config core.hooksPath /dev/null

      - name: Verify Lockfile & DevDeps
        shell: bash
        run: bash scripts/verify-lockfile.sh

      - name: Install Dependencies
        run: npm ci

      - name: Run Doctor Check
        run: npm run doctor

      - name: Security Audit (Production Only)
        run: npm audit --omit=dev --audit-level=high || true
