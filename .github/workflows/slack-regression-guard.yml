name: Slack Regression Guard
on: [pull_request, push]
jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    strategy:
      fail-fast: true
      matrix:
        shard: [1, 2]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with: { fetch-depth: 0 }
      - name: Check for Slack references (shard ${{ matrix.shard }})
        run: |
          set -euo pipefail
          # Split files across shards for faster execution
          files=$(git ls-files | head -n $((${{ matrix.shard }} * 500)))

          # Search tracked files for Slack indicators; allow known workflows; ignore backups/artifacts
          if git grep -n -i \
               -e 'hooks\.slack\.com' \
               -e '@slack/webhook' \
               -e '@slack/types' \
               -e '\bslack\b' \
               -- $files \
            ':!.github/workflows/slack-regression-guard.yml' \
            ':!.github/workflows/staging-monitor.yml' \
            ':!.github/workflows/bmad-weekly.yml' \
            ':!.github/workflows/deploy-ga.yml' \
            ':!.github/workflows/synthetic.yml' \
            ':!.env.example' \
            ':!**/*.backup*' \
            ':!**/.package-lock.json*' \
            ':!artifacts/**' \
            ':!docs/legacy/*' \
            ':!.migration/*' \
            ':!.config/*' \
            ':!*.md' \
            ':!tatus' \
            ':!docs/*' \
            ':!observability/*' \
            ':!packages/*/README.md' \
            ':!repo/*' \
            ':!scripts/apply-hotfixes.sh' \
            ':!scripts/update-branch-protection.js' \
            ':!.github/dependabot.yml' \
            ':!.github/workflows/ci-hygiene.yml' \
            ':!.github/workflows/maintenance.yml' \
            ':!.github/workflows/migration-orchestrator.yml' \
            ':!launch-script.sh' \
            ':!shared/slack.ts' \
            ':!services/SlackService.ts' \
            ':!eslint.config.js' \
            ':!**/*slack*.ts' \
            ':!**/*Slack*.ts'; then
            echo '❌  Slack reference found in shard ${{ matrix.shard }}'; exit 1
          fi
          echo '✅  Shard ${{ matrix.shard }} Slack-free'
