groups:
  - name: rum_web_vitals
    interval: 30s
    rules:
      # LCP (Largest Contentful Paint) Alerts
      - alert: LCPBudgetFastBurn
        expr: histogram_quantile(0.75, sum by (le) (rate(web_vitals_lcp_bucket[2m]))) > 2.5
        for: 2m
        labels:
          severity: page
          team: frontend
        annotations:
          summary: "LCP p75 > 2.5s (fast burn)"
          description: "Page load performance degrading rapidly. LCP p75: {{ $value | humanizeDuration }}"
          runbook: "https://docs.example.com/runbooks/web-vitals#lcp"
      
      - alert: LCPBudgetSlowBurn
        expr: histogram_quantile(0.75, sum by (le) (rate(web_vitals_lcp_bucket[1h]))) > 2.5
        for: 1h
        labels:
          severity: ticket
          team: frontend
        annotations:
          summary: "LCP p75 > 2.5s (sustained)"
          description: "Sustained page load degradation. LCP p75: {{ $value | humanizeDuration }}"
          runbook: "https://docs.example.com/runbooks/web-vitals#lcp"
      
      # Mobile-specific LCP
      - alert: LCPMobileFastBurn
        expr: histogram_quantile(0.75, sum by (le) (rate(web_vitals_lcp_bucket{device="mobile"}[2m]))) > 3.0
        for: 2m
        labels:
          severity: page
          team: frontend
          device: mobile
        annotations:
          summary: "Mobile LCP p75 > 3s (fast burn)"
          description: "Mobile page load degrading. LCP p75: {{ $value | humanizeDuration }}"
      
      # INP (Interaction to Next Paint) Alerts
      - alert: INPBudgetFastBurn
        expr: histogram_quantile(0.75, sum by (le) (rate(web_vitals_inp_bucket[2m]))) > 200
        for: 2m
        labels:
          severity: page
          team: frontend
        annotations:
          summary: "INP p75 > 200ms (fast burn)"
          description: "Page interactivity degrading. INP p75: {{ $value }}ms"
          runbook: "https://docs.example.com/runbooks/web-vitals#inp"
      
      - alert: INPBudgetSlowBurn
        expr: histogram_quantile(0.75, sum by (le) (rate(web_vitals_inp_bucket[1h]))) > 200
        for: 1h
        labels:
          severity: ticket
          team: frontend
        annotations:
          summary: "INP p75 > 200ms (sustained)"
          description: "Sustained interactivity issues. INP p75: {{ $value }}ms"
      
      # CLS (Cumulative Layout Shift) Alerts
      - alert: CLSBudgetExceeded
        expr: histogram_quantile(0.95, sum by (le) (rate(web_vitals_cls_bucket[5m]))) > 0.1
        for: 10m
        labels:
          severity: ticket
          team: frontend
        annotations:
          summary: "CLS p95 > 0.1"
          description: "Layout stability issues detected. CLS p95: {{ $value | humanize }}"
          runbook: "https://docs.example.com/runbooks/web-vitals#cls"
  
  - name: rum_ingestion
    interval: 30s
    rules:
      # Ingestion health
      - alert: RUMIngestRejectRatioHigh
        expr: |
          rate(rum_ingest_rejected_total[10m]) / 
          (rate(rum_ingest_total{status="success"}[10m]) + rate(rum_ingest_rejected_total[10m])) > 0.01
        for: 10m
        labels:
          severity: ticket
          team: platform
        annotations:
          summary: "RUM beacon rejection rate > 1%"
          description: "High rejection rate: {{ $value | humanizePercentage }}. Check schema, origin, or cardinality limits."
          runbook: "https://docs.example.com/runbooks/rum#high-rejection"
      
      # Cardinality explosion
      - alert: RUMCardinalityCritical
        expr: rum_dropped_cardinality_total > 100
        for: 5m
        labels:
          severity: page
          team: platform
        annotations:
          summary: "RUM cardinality budget exceeded"
          description: "Label cardinality limits being hit. Dimension: {{ $labels.dimension }}"
          runbook: "https://docs.example.com/runbooks/rum#cardinality"
      
      # Origin validation failures
      - alert: RUMOriginMismatchHigh
        expr: rate(rum_ingest_rejected_total{reason="origin_mismatch"}[5m]) > 1
        for: 5m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "High rate of RUM origin mismatches"
          description: "Potential CSRF or misconfiguration. Rate: {{ $value | humanize }}/s"
      
      # Replay attack detection
      - alert: RUMStaleTimestampHigh
        expr: rate(rum_ingest_rejected_total{reason="stale_timestamp"}[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "High rate of stale RUM beacons"
          description: "Potential replay attack or clock skew. Rate: {{ $value | humanize }}/s"
  
  # SLO Burn Rate Rules (Multi-Window Multi-Burn-Rate)
  - name: slo_burn_rates
    interval: 30s
    rules:
      # LCP SLO: 75% of page loads < 2.5s
      - alert: LCPSLOFastBurn
        expr: |
          (
            1 - (
              increase(web_vitals_lcp_bucket{le="2500"}[5m]) /
              increase(web_vitals_lcp_count[5m])
            )
          ) > (1 - 0.75) * 14.4
        for: 5m
        labels:
          severity: page
          slo: lcp_p75_2500ms
          burn_rate: fast
          team: frontend
        annotations:
          summary: "LCP SLO fast burn (14.4x in 5m)"
          description: "LCP SLO burning 14.4x faster than budget. Will exhaust error budget in 1 hour at this rate."
          dashboard: "https://grafana.example.com/d/rum-slo"
      
      - alert: LCPSLOSlowBurn
        expr: |
          (
            1 - (
              increase(web_vitals_lcp_bucket{le="2500"}[1h]) /
              increase(web_vitals_lcp_count[1h])
            )
          ) > (1 - 0.75) * 1
        for: 1h
        labels:
          severity: ticket
          slo: lcp_p75_2500ms
          burn_rate: slow
          team: frontend
        annotations:
          summary: "LCP SLO slow burn (1x in 1h)"
          description: "LCP SLO burning at 1x rate. Will exhaust monthly error budget in 30 days."
      
      # INP SLO: 75% of interactions < 200ms
      - alert: INPSLOFastBurn
        expr: |
          (
            1 - (
              increase(web_vitals_inp_bucket{le="200"}[5m]) /
              increase(web_vitals_inp_count[5m])
            )
          ) > (1 - 0.75) * 14.4
        for: 5m
        labels:
          severity: page
          slo: inp_p75_200ms
          burn_rate: fast
          team: frontend
        annotations:
          summary: "INP SLO fast burn (14.4x in 5m)"
          description: "Interaction responsiveness burning error budget 14.4x faster."
      
      - alert: INPSLOSlowBurn
        expr: |
          (
            1 - (
              increase(web_vitals_inp_bucket{le="200"}[1h]) /
              increase(web_vitals_inp_count[1h])
            )
          ) > (1 - 0.75) * 1
        for: 1h
        labels:
          severity: ticket
          slo: inp_p75_200ms
          burn_rate: slow
          team: frontend
        annotations:
          summary: "INP SLO slow burn (1x in 1h)"
          description: "Sustained INP degradation at 1x burn rate."
      
      # API Latency SLO: 95% of requests < 500ms
      - alert: APISLOFastBurn
        expr: |
          (
            1 - (
              histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{le="0.5"}[5m])) /
              rate(http_request_duration_seconds_count[5m])
            )
          ) > (1 - 0.95) * 14.4
        for: 5m
        labels:
          severity: page
          slo: api_p95_500ms
          burn_rate: fast
          team: backend
        annotations:
          summary: "API SLO fast burn (14.4x in 5m)"
          description: "API latency burning error budget rapidly."
      
      # RUM Ingestion SLO: 99% success rate
      - alert: RUMIngestionSLOBurn
        expr: |
          (
            rate(rum_ingest_rejected_total[5m]) /
            (rate(rum_ingest_total[5m]) + rate(rum_ingest_rejected_total[5m]))
          ) > 0.01 * 14.4
        for: 5m
        labels:
          severity: page
          slo: rum_ingestion_99
          burn_rate: fast
          team: platform
        annotations:
          summary: "RUM ingestion SLO burn (>1% reject rate)"
          description: "RUM beacon rejection burning error budget."